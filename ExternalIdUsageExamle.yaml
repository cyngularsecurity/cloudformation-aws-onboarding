---
AWSTemplateFormatVersion: '2010-09-09'
Description: Antimetal role setup

Conditions:
  UseExternalID: !Not 
    - !Equals 
      - !Ref ExternalID
      - ''
  UseHandshakeID: !Not 
    - !Equals 
      - !Ref HandshakeID
      - ''

Parameters:
  AntimetalPrincipal:
    Description: Antimetal IAM Principal used to access your AWS account
    Type: String
  ExternalID:
    Default: ''
    Description: External ID generated by Antimetal to provide secure access to your AWS account
    NoEcho: true
    Type: String
  HandshakeID:
    Default: ''
    Description: Unique Antimetal handshake identitifer
    NoEcho: true
    Type: String
  RoleName:
    Description: Name for the IAM Role Antimetal will use to connect to your AWS account
    Type: String

Resources:
  AntimetalHandshake:
    Condition: UseHandshakeID
    DependsOn: AntimetalGroupPolicy
    Type: Custom::AntimetalHandshake
    Properties:
      ExternalID: !If 
        - UseExternalID
        - !Ref ExternalID
        - !Select 
          - 2
          - !Split 
            - "/"
            - !Ref AWS::StackId
      HandshakeID: !Ref HandshakeID
      RoleArn: !GetAtt AntimetalGroupsRole.Arn
      RoleName: !Ref RoleName
      ServiceToken: arn:aws:sns:us-east-1:984606353847:AntimetalRoleSetup

  AntimetalGroupPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: AntimetalRolePolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - application-autoscaling:Describe*
              - autoscaling:Describe*
              - ce:*
              - cur:Get*
              - cur:Describe*
              - cloudwatch:GetMetricData
              - ec2:Describe*
              - ec2:AcceptReservedInstancesExchangeQuote
              - ec2:CancelReservedInstancesListing
              - ec2:CreateReservedInstancesListing
              - ec2:DeleteQueuedReservedInstances
              - ec2:ModifyReservedInstances
              - ec2:PurchaseHostReservation
              - ec2:PurchaseReservedInstancesOffering
              - elasticache:List*
              - elasticache:Describe*
              - elasticache:PurchaseReservedCacheNodesOffering
              - es:Describe*
              - es:List*
              - es:PurchaseReservedInstanceOffering
              - organizations:InviteAccountToOrganization
              - organizations:List*
              - organizations:Describe*
              - organizations:AcceptHandshake
              - iam:CreateServiceLinkedRole
              - pricing:DescribeServices
              - pricing:GetAttributeValues
              - pricing:GetProducts
              - rds:Describe*
              - rds:List*
              - rds:PurchaseReservedDbInstancesOffering
              - savingsplans:Describe*
              - savingsplans:List*
              - savingsplans:CreateSavingsPlan
              - servicequotas:Get*
              - servicequotas:List*
              - servicequotas:RequestServiceQuotaIncrease
              - sagemaker:Describe*
              - sagemaker:List*
              - medialive:Describe*
              - medialive:List*
              - medialive:PurchaseOffering
              - redshift:Describe*
              - redshift:List*
              - redshift:PurchaseReservedNodeOffering
              - support:*
              - compute-optimizer:*
              - cost-optimization-hub:*
            Resource: "*"
      Roles:
        - !Ref AntimetalGroupsRole

  AntimetalGroupsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: AntimetalGroupsRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal:
              AWS: !Ref AntimetalPrincipal
            Condition:
              StringEquals:
                sts:ExternalId: !If 
                  - UseExternalID
                  - !Ref ExternalID
                  - !Select 
                    - 2
                    - !Split 
                      - "/"
                      - !Ref AWS::StackId
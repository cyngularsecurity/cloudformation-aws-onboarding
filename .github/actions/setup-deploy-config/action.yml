name: 'Setup Deployment Configuration'
description: 'Centralizes deployment configuration and environment variable setup'

inputs:
  environment:
    description: 'Target environment (dev/stg/prod)'
    required: false
    default: 'dev'
  dev_aws_account_id:
    description: 'AWS Account ID for dev environment'
    required: false
  stg_aws_account_id:
    description: 'AWS Account ID for stg environment'
    required: false
  prod_aws_account_id:
    description: 'AWS Account ID for prod environment'
    required: false

outputs:
  s3_bucket_cfn:
    description: 'Centralized S3 bucket for CloudFormation templates'
    value: ${{ steps.config.outputs.s3_bucket_cfn }}
  bucket_pattern_regional:
    description: 'Base bucket pattern for regional deployments'
    value: ${{ steps.config.outputs.bucket_pattern_regional }}
  aws_region:
    description: 'Primary AWS region'
    value: ${{ steps.config.outputs.aws_region }}
  python_version:
    description: 'Python version for consistency'
    value: ${{ steps.config.outputs.python_version }}
  timestamp:
    description: 'Deployment timestamp for versioning'
    value: ${{ steps.config.outputs.timestamp }}
  deploy_role_arn:
    description: 'AWS IAM role ARN for deployment'
    value: ${{ steps.config.outputs.deploy_role_arn }}

runs:
  using: 'composite'
  steps:
    - name: Set deployment configuration
      id: config
      shell: bash
      run: |
        ENV="${{ inputs.environment }}"
        
        # Set AWS region (centralized)
        echo "aws_region=us-east-1" >> $GITHUB_OUTPUT
        
        # Set Python version
        echo "python_version=3.11" >> $GITHUB_OUTPUT
        
        # Generate deployment timestamp
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        
        # Validate required account ID inputs exist
        case "$ENV" in
          "prod")
            if [ -z "${{ inputs.prod_aws_account_id }}" ]; then
              echo "::error::PROD_AWS_ACCOUNT_ID secret is not set in repository"
              exit 1
            fi
            ;;
          "stg")
            if [ -z "${{ inputs.stg_aws_account_id }}" ]; then
              echo "::error::STG_AWS_ACCOUNT_ID secret is not set in repository"
              exit 1
            fi
            ;;
          "dev")
            if [ -z "${{ inputs.dev_aws_account_id }}" ]; then
              echo "::error::DEV_AWS_ACCOUNT_ID secret is not set in repository"
              exit 1
            fi
            ;;
        esac
        
        # Debug: Show which environment we're configuring
        echo "::notice::Configuring for environment: $ENV"
        
        # Define ARN components centrally to avoid repetition
        ROLE_ARN_PREFIX="arn:aws:iam::"
        ROLE_ARN_SUFFIX=":role/GitHubActionsRunnerRole"
        
        # Set centralized S3 bucket for CFN templates and AWS account ID
        # NOTE: We construct the ARN in parts to avoid GitHub's secret masking
        case "$ENV" in
          "prod")
            ACCOUNT_ID="${{ inputs.prod_aws_account_id }}"
            echo "::notice::Using PROD account ID (length: ${#ACCOUNT_ID})"
            echo "s3_bucket_cfn=cyngular-onboarding" >> $GITHUB_OUTPUT
            echo "bucket_pattern_regional=cyngular-onboarding" >> $GITHUB_OUTPUT
            # Construct ARN to avoid secret masking issues
            FULL_ARN="${ROLE_ARN_PREFIX}${ACCOUNT_ID}${ROLE_ARN_SUFFIX}"
            echo "deploy_role_arn=${FULL_ARN}" >> $GITHUB_OUTPUT
            ;;
          "stg")
            ACCOUNT_ID="${{ inputs.stg_aws_account_id }}"
            echo "::notice::Using STG account ID (length: ${#ACCOUNT_ID})"
            echo "s3_bucket_cfn=stg-cyngular-onboarding" >> $GITHUB_OUTPUT
            echo "bucket_pattern_regional=stg-cyngular-onboarding" >> $GITHUB_OUTPUT
            # Construct ARN to avoid secret masking issues
            FULL_ARN="${ROLE_ARN_PREFIX}${ACCOUNT_ID}${ROLE_ARN_SUFFIX}"
            echo "deploy_role_arn=${FULL_ARN}" >> $GITHUB_OUTPUT
            ;;
          "dev")
            ACCOUNT_ID="${{ inputs.dev_aws_account_id }}"
            echo "::notice::Using DEV account ID (length: ${#ACCOUNT_ID})"
            echo "s3_bucket_cfn=dev-cyngular-onboarding" >> $GITHUB_OUTPUT
            echo "bucket_pattern_regional=dev-cyngular-onboarding" >> $GITHUB_OUTPUT
            # Construct ARN to avoid secret masking issues
            FULL_ARN="${ROLE_ARN_PREFIX}${ACCOUNT_ID}${ROLE_ARN_SUFFIX}"
            echo "deploy_role_arn=${FULL_ARN}" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "::error::Unknown environment: $ENV"
            exit 1
            ;;
        esac
        
        # Debug: Verify outputs were set (without exposing the actual value)
        echo "::notice::Role ARN construction completed for $ENV environment"
        
    - name: Display deployment configuration
      shell: bash
      run: |
        echo "üöÄ Deployment Configuration:"
        echo "  Environment: ${{ inputs.environment }}"
        echo "  CFN S3 Bucket: ${{ steps.config.outputs.s3_bucket_cfn }}"
        echo "  Regional Bucket Pattern: ${{ steps.config.outputs.bucket_pattern_regional }}"
        echo "  AWS Region: ${{ steps.config.outputs.aws_region }}"
        echo "  Python Version: ${{ steps.config.outputs.python_version }}"
        echo "  Timestamp: ${{ steps.config.outputs.timestamp }}"
        echo "  Deploy Role ARN: ${{ steps.config.outputs.deploy_role_arn }}"
        
        # Debug output for troubleshooting
        echo ""
        echo "üîç Debug Information:"
        echo "  Dev Account ID (masked): ${{ inputs.dev_aws_account_id && '***' || 'NOT SET' }}"
        echo "  Stg Account ID (masked): ${{ inputs.stg_aws_account_id && '***' || 'NOT SET' }}"
        echo "  Prod Account ID (masked): ${{ inputs.prod_aws_account_id && '***' || 'NOT SET' }}"
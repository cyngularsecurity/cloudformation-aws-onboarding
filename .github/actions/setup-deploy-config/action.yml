name: 'Setup Deployment Configuration'
description: 'Centralizes deployment configuration and environment variable setup'

inputs:
  environment:
    description: 'Target environment (dev/stg/prod)'
    required: false
    default: 'dev'

outputs:
  s3_bucket_cfn:
    description: 'Centralized S3 bucket for CloudFormation templates'
    value: ${{ steps.config.outputs.s3_bucket_cfn }}
  bucket_pattern_regional:
    description: 'Base bucket pattern for regional deployments'
    value: ${{ steps.config.outputs.bucket_pattern_regional }}
  aws_region:
    description: 'Primary AWS region'
    value: ${{ steps.config.outputs.aws_region }}
  python_version:
    description: 'Python version for consistency'
    value: ${{ steps.config.outputs.python_version }}
  timestamp:
    description: 'Deployment timestamp for versioning'
    value: ${{ steps.config.outputs.timestamp }}
  deploy_role_arn:
    description: 'AWS IAM role ARN for deployment'
    value: ${{ steps.config.outputs.deploy_role_arn }}

runs:
  using: 'composite'
  steps:
    - name: Set deployment configuration
      id: config
      shell: bash
      run: |
        ENV="${{ inputs.environment }}"
        
        # Set AWS region based on environment
        case "$ENV" in
          "prod")
            echo "aws_region=us-east-1" >> $GITHUB_OUTPUT
            ;;
          "stg")
            echo "aws_region=us-east-2" >> $GITHUB_OUTPUT
            ;;
          "dev")
            echo "aws_region=us-west-2" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "::error::Unknown environment: $ENV"
            exit 1
            ;;
        esac
        
        # Set Python version
        echo "python_version=3.11" >> $GITHUB_OUTPUT
        
        # Generate deployment timestamp
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        
        # Set centralized S3 bucket for CFN templates
        case "$ENV" in
          "prod")
            echo "s3_bucket_cfn=cyngular-onboarding-templates" >> $GITHUB_OUTPUT
            echo "bucket_pattern_regional=cyngular-onboarding" >> $GITHUB_OUTPUT
            ;;
          "stg")
            echo "s3_bucket_cfn=stg-cyngular-onboarding-templates" >> $GITHUB_OUTPUT
            echo "bucket_pattern_regional=stg-cyngular-onboarding" >> $GITHUB_OUTPUT
            ;;
          "dev")
            echo "s3_bucket_cfn=dev-cyngular-onboarding-templates" >> $GITHUB_OUTPUT
            echo "bucket_pattern_regional=dev-cyngular-onboarding" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "::error::Unknown environment: $ENV"
            exit 1
            ;;
        esac
        
    - name: Display deployment configuration
      shell: bash
      run: |
        echo "üöÄ Deployment Configuration:"
        echo "  Environment: ${{ inputs.environment }}"
        echo "  CFN S3 Bucket: ${{ steps.config.outputs.s3_bucket_cfn }}"
        echo "  Regional Bucket Pattern: ${{ steps.config.outputs.bucket_pattern_regional }}"
        echo "  AWS Region: ${{ steps.config.outputs.aws_region }}"
        echo "  Python Version: ${{ steps.config.outputs.python_version }}"
        echo "  Timestamp: ${{ steps.config.outputs.timestamp }}"
        echo "  Deploy Role ARN: ${{ steps.config.outputs.deploy_role_arn }}"
        
        # Debug output for troubleshooting
        echo ""
        echo "üîç Debug Information:"
        echo "  Dev Account ID (masked): ${{ inputs.dev_aws_account_id && '***' || 'NOT SET' }}"
        echo "  Stg Account ID (masked): ${{ inputs.stg_aws_account_id && '***' || 'NOT SET' }}"
        echo "  Prod Account ID (masked): ${{ inputs.prod_aws_account_id && '***' || 'NOT SET' }}"
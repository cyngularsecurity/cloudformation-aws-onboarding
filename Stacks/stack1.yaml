AWSTemplateFormatVersion: 2010-09-09
Description: Cyngular organization managment stack template

Parameters:
  ClientName:
    Description: The name of the client. (must be lowercase, can contain letters, numbers and dashes)
    Type: String
    AllowedPattern: "^[a-z0-9](?:[a-z0-9\\-\\.]*[a-z0-9])?$"
    MinLength: 3
    MaxLength: 10

  OrganizationId:
    Description: "Specify whether the client is using an Organization { '0' / 'ID' }"
    Type: String

  CyngularAccountId:
    Description: "The cyngular Account ID to assume read only role"
    Type: String
    MinLength: 12
    MaxLength: 12
    AllowedPattern: '^[0-9]{12}$'
    ConstraintDescription: "Must be exactly 12 digits."
    Default: 851565895544

  ClientRegions:
    Description: The regions in which the client operates (comma-separated for example; us-east-1,us-east-2), make sure all regions listed are enabled in the relevent accounts
    Type: CommaDelimitedList
    # AllowedValues: [me-south-1, us-east-1, us-east-2, us-west-1, us-west-2, ap-southeast-1, ap-southeast-2, ap-south-1, ap-northeast-1, ap-northeast-2, ap-northeast-3, af-south-1, eu-west-1, eu-west-2, eu-west-3, eu-central-1, eu-north-1, eu-south-1, ca-central-1, sa-east-1, il-central-1, af-north-1, ap-east-1]
    AllowedValues:
      - me-south-1
      - us-east-1
      - us-east-2
      - us-west-1
      - us-west-2
      - ap-southeast-1
      - ap-southeast-2
      - ap-south-1
      - ap-northeast-1
      - ap-northeast-2
      - ap-northeast-3
      - af-south-1
      - eu-west-1
      - eu-west-2
      - eu-west-3
      - eu-central-1
      - eu-north-1
      - eu-south-1
      - ca-central-1
      - sa-east-1
      - il-central-1
  
  Stack2URL:
    Description: 'The link to the stack2 template url'
    Type: String
    Default: 'https://cyngular-onboarding-templates.s3.amazonaws.com/stacks/stack2.yaml'

  StackSet1URL:
    Description: 'The link to the stackset1 template url'
    Type: String
    Default: 'https://cyngular-onboarding-templates.s3.amazonaws.com/stacks/stackset_child1.yaml'

  StackSet2URL:
    Description: 'The link to the stackset2 template url'
    Type: String
    Default: 'https://cyngular-onboarding-templates.s3.amazonaws.com/stacks/stackset_child2.yaml'

#   OUList:
#   AccountList:
#   DeployList: # check if empty, and others are not, concat

#   EnableGuardDuty:
#     Description: "GuardDuty Service - Create GuardDuty Detector"
#     Type: String
#     AllowedValues: ["true", "false"]
#     Default: "true"

#   EnableDNS:
#     Description: "DNS Service - Whether to Create Route 53 Resolver, for logging vpc flows"
#     Type: String
#     AllowedValues: ["true", "false"]
#     Default: "true"

#   EnableCloudTrail:
#     Description: "CloudTrail Service - Whether to Create CloudTrail Trail, for logging account entities actions over time"
#     Type: String
#     AllowedValues: ["true", "false"]
#     Default: "true"

Conditions:
  IsOrg: !Not [!Equals [!Ref OrganizationId, "0"]]

#   CreateDNSResources: !Equals [ !Ref DNSEnabled, "true" ]
#   EnableVPCFlowLogs: !Equals [ !Ref VPCFlowLogsEnabled, "true" ]
#   EnableGuardDuty: !Equals [ !Ref GuardDutyEnabled, "true" ]
#   EnableCloudTrail: !Equals [ !Ref CloudTrailEnabled, "true" ]

#   EnableCloudTrail: !Equals [ !Ref CloudTrailEnabled, "true" ]

#   EnableGuardDutyCondition: !Equals [!Ref EnableGuardDuty, "true"]
#   EnableResolverCondition: !Equals [!Ref EnableResolver, "true"]
#   # DeployGuardDutyForAccounts: !And [!Condition EnableGuardDutyForOrg, !Not [!Equals [!Ref AccountList, "0"]]]
#   # DeployGuardDutyForOUs: !And [!Condition EnableGuardDutyForOrg, !Not [!Equals [!Ref OUList, "0"]]]
#   # DeployResolverForAccounts: !And [!Condition EnableResolverForOrg, !Not [!Equals [!Ref AccountList, "0"]]]
#   # DeployResolverForOUs: !And [!Condition EnableResolverForOrg, !Not [!Equals [!Ref OUList, "0"]]]

#   # if DeployList is empty and others are not
#   CheckDeployList: !And
#     - !Equals [!Ref DeployList, "0"]
#     - !Not [!Equals [!Ref AccountList, "0"]]
#     - !Not [!Equals [!Ref OUList, "0"]]

Resources:
  #------------------Cyngular Bucket-------------------
  # CyngularS3Bucket:
  #   Type: AWS::S3::Bucket
  #   Properties:
  #     BucketName: !Join ['-', ['cyngular', !Ref ClientName, 'bucket', !Ref AWS::AccountId]]
  #     BucketEncryption:
  #       ServerSideEncryptionConfiguration: 
  #         - ServerSideEncryptionByDefault:
  #             SSEAlgorithm: 'AES256'
  #     PublicAccessBlockConfiguration: 
  #       BlockPublicAcls: True
  #       BlockPublicPolicy: True
  #       IgnorePublicAcls: True
  #       RestrictPublicBuckets: True
  #     Tags: 
  #       - Key: Name
  #         Value: !Join ['-', ['cyngular', !Ref ClientName, 'bucket', !Ref AWS::AccountId]]

  S3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CyngularS3Bucket

      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: 'CloudTrailAclCheck'
            Effect: 'Allow'
            Principal: 
              Service: "cloudtrail.amazonaws.com"
            Action:
              - 's3:GetBucketAcl'
            Resource: !GetAtt CyngularS3Bucket.Arn
            Condition:
              StringEquals:
                "AWS:SourceArn": !Sub "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/cyngular-cloudtrail"
        #   - Sid: 'CloudTrailWriteAcc'
        #     Effect: 'Allow'
        #     Principal: 
        #       Service: "cloudtrail.amazonaws.com"
        #     Action:
        #       - 's3:PutObject'
        #     Resource: !Sub "${CyngularS3Bucket.Arn}/AWSLogs/${AWS::AccountId}/*"
        #     Condition:
        #       StringEquals:
        #         - "s3:x-amz-acl": "bucket-owner-full-control"
        #         - "AWS:SourceArn": !Sub "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/cyngular-cloudtrail"
        # #   - !If 
        # #     - EnableCloudTrail
        # #     - Effect: "Allow"
        # #         Action:
        # #         - "cloudtrail:DescribeTrails"
        # #         - "cloudtrail:GetTrailStatus"
        # #         Resource: "*"
        # #     - !Ref "AWS::NoValue"

        #   - Sid: 'CloudTrailWriteOrg'
        #     Effect: 'Allow'
        #     Principal: 
        #       Service: "cloudtrail.amazonaws.com"
        #     Action:
        #       - 's3:PutObject'
        #     Resource: !Sub "${CyngularS3Bucket.Arn}/AWSLogs/${OrganizationId}/*"
        #     Condition:
        #       StringEquals:
        #         - "s3:x-amz-acl": "bucket-owner-full-control"
        #         - "AWS:SourceArn": !Sub "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/cyngular-cloudtrail"
        #   - Sid: 'AthenaLambdaRead'
        #     Effect: 'Allow'
        #     Principal: 
        #       Service: "lambda.amazonaws.com"
        #     Action:
        #       - 's3:GetBucketLocation'
        #       - 's3:GetObject'
        #       - 's3:ListBucket'
        #       - 's3:ListBucketMultipartUploads'
        #       - 's3:ListMultipartUploadParts'
        #       - 's3:AbortMultipartUpload'
        #     Resource: 
        #       - !Sub "${CyngularS3Bucket.Arn}/AWSLogs/${OrganizationId}/*"
        #       - !Sub "${CyngularS3Bucket.Arn}/AWSLogs/${AWS::AccountId}/*"
        #     Condition:
        #       ArnLike:
        #         "aws:SourceArn": !Sub "arn:aws:lambda:${AWS::Region}:${CyngularAccountId}:function:Search_Athena_Lambda-${ClientName}"

  ClientCloudTrail: 
    DependsOn: S3BucketPolicy
    # Condition: CreateCloudTrail
    Type: AWS::CloudTrail::Trail
    Properties: 
      S3BucketName: !Ref CyngularS3Bucket
      IsMultiRegionTrail: True
      IsOrganizationTrail: True
      IncludeGlobalServiceEvents: True
      InsightSelectors: 
          - InsightType : ApiCallRateInsight
          - InsightType : ApiErrorRateInsight
      TrailName: cyngular-cloudtrail
      IsLogging: true
      EventSelectors:
        - IncludeManagementEvents: True
          ExcludeManagementEventSources: 
            - kms.amazonaws.com
          DataResources: 
            - Type: 'AWS::Lambda::Function'
              Values: 
                - 'arn:aws:lambda'
      Tags: 
        - Key: Name
          Value: cyngular-cloudtrail

#------------------Cyngular Client Role-------------------
  ClientCyngularRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Join ['-', ['cyngular-readonly-role', !Ref ClientName]]
      AssumeRolePolicyDocument:
        {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": !Join ['', ["arn:aws:iam::", !Ref CyngularAccountId, ":root"]]
            },
            "Action": "sts:AssumeRole",
            "Condition": {}
        }
    ]
    }
      Policies:
        - PolicyName: "cyngular-readonly-policy"
          PolicyDocument: {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Sid": "ec2CyngularSnapshot",
                "Effect": "Allow",
                "Action": [
                    "ec2:DeleteSnapshot",
                    "ec2:ModifySnapshotAttribute"
                ],
                "Resource": "*",
                "Condition": {
                    "StringLike": {
                        "aws:ResourceTag/Name": "cyngular*"
                    }
                }
            },
            {
                "Sid": "ec2CreateSnapshot",
                "Effect": "Allow",
                "Action": [
                    "ec2:CopySnapshot",
                    "ec2:CreateSnapshot",
                    "ec2:CreateSnapshots"
                ],
                "Resource": "*"
            },
            {
                "Sid": "readOnly",
                "Effect": "Allow",
                "Action": [
                    "kms:List*",
                    "kms:Describe*",

                    "iam:List*",
                    "iam:Get*",

                    "rds:List*",

                    "s3:List*",
                    "s3:Describe*",
                    "s3:GetBucketLocation",

                    "logs:List*",
                    "logs:Describe*",
                    "logs:Get*",
                    "logs:FilterLogEvents",

                    "rds:Describe*",

                    "ecr:Describe*",
                    "ecr:List*",

                    "eks:Describe*",
                    "eks:List*",

                    "ecs:List*",

                    "ec2:List*",
                    "ec2:CreateTags",
                    "ecs:Describe*",
                    "ec2:Describe*",

                    "lambda:List*",
                    "lambda:Get*",

                    "organizations:Describe*",
                    "organizations:List*",

                    "cloudformation:Describe*",
                    "cloudformation:List*",
                    "cloudformation:Get*",

                    "guardduty:List*",
                    "guardduty:Get*",

                    "ce:GetCostAndUsage",
                    "ce:GetDimensionValues"
                ],
                "Resource": "*"
            },
            {
                "Sid": "s3GetObject",
                "Effect": "Allow",
                "Action": "s3:GetObject*",
                "Resource": [
                    !Join ['', ['arn:aws:s3:::cyngular-', !Ref ClientName, '-bucket-', !Ref AWS::AccountId]],
                    !Join ['', ['arn:aws:s3:::cyngular-', !Ref ClientName, '-bucket-', !Ref AWS::AccountId, '/*']]
                ]
            },
            {
                "Sid": "volumeDecrypt",
                "Effect": "Allow",
                "Action": [
                    "kms:Decrypt",
                    "kms:CreateGrant"
                ],
                "Resource": "*"
            },
            {
                "Sid": "cyngularKmsKey",
                "Effect": "Allow",
                "Action": [
                    "kms:*"
                ],
                "Resource": "*",
                "Condition": {
                    "StringLike": {
                        "aws:ResourceTag/Name": "cyngular*"
                    }
                }
            }
        ]
    }
#------------------Cyngular Lambda A Role-------------------  
  LambdasRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Join ['', ['cyngular-lambda-role-', !Ref ClientName]]
      AssumeRolePolicyDocument:
        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Principal": {
                        "Service": "lambda.amazonaws.com"
                    },
                    "Action": "sts:AssumeRole"
                }
            ]
        }

      Policies:
        - PolicyName: "cyngular-lambda-policy"
          PolicyDocument: {
                              "Version": "2012-10-17",
                              "Statement": [
                                  {
                                      "Sid": "VisualEditor0",
                                      "Effect": "Allow",
                                      "Action": [
                                          "route53resolver:*",

                                          "organizations:ListAccounts",

                                          "ec2:Describe*",
                                          "ec2:CreateFlowLogs",
                                          "ec2:CreateTags",
                                          "ec2:DeleteFlowLogs",
                                          "ec2:DeleteTags",

                                          "ssm:*",

                                          "logs:*",

                                          "eks:List*",
                                          "eks:UpdateClusterConfig",

                                          "guardduty:*"                                            
                                      ],
                                      "Resource": "*"
                                  },
                                  {
                                      "Sid": "cyngularEvent",
                                      "Effect": "Allow",
                                      "Action": [
                                          "events:*"
                                      ],
                                      "Resource": "*"
                                  },
                                  {
                                      "Sid": "cyngularBuckets",
                                      "Effect": "Allow",
                                      "Action": [
                                          "s3:*"
                                      ],
                                      "Resource": [
                                        !Join ['', ['arn:aws:s3:::cyngular-', !Ref ClientName, '-bucket-', !Ref AWS::AccountId]],
                                        !Join ['', ['arn:aws:s3:::cyngular-', !Ref ClientName, '-bucket-', !Ref AWS::AccountId, '/*']]
                                      ]
                                  }
                              ]
                          }

#   CyngularLambdaA:
#     Type: AWS::Lambda::Function
#     Properties:
#       FunctionName: cyngular-lambda-create-resources
#       Description: Created by Cyngular Security.
#       Code:
#         # S3Bucket: !Ref S3BucketURL
#         # S3Key: path/to/code.zip
#         ZipFile: !Sub | 
#             import boto3
#             import traceback
#             import os
#             import logging

#             def osinternals(cur_region_name):
#                 try:
#                     logging.info('STARTING OS INTERNALS...')
#                     ec2_client = boto3.client('ec2', region_name=cur_region_name)
#                     ssm_client = boto3.client('ssm', region_name=cur_region_name)

#                     all_instances = ec2_client.describe_instances()
#                     instance_ids = []
#                     for reservation in all_instances['Reservations']:
#                         for instance in reservation['Instances']:
#                             instance_ids.append(instance['InstanceId'])

#                     auditd_rules = 'IyAgICAgIF9fXyAgICAgICAgICAgICBfX18gX18gICAgICBfXwojICAgICAvICAgfCBfXyAgX19fX19fLyAoXykgL19fX19fLyAvCiMgICAgLyAvfCB8LyAvIC8gLyBfXyAgLyAvIF9fLyBfXyAgLwojICAgLyBfX18gLyAvXy8gLyAvXy8gLyAvIC9fLyAvXy8gLwojICAvXy8gIHxfXF9fLF8vXF9fLF8vXy9cX18vXF9fLF8vCiMKIyBMaW51eCBBdWRpdCBEYWVtb24gLSBCZXN0IFByYWN0aWNlIENvbmZpZ3VyYXRpb24KIyAvZXRjL2F1ZGl0L2F1ZGl0LnJ1bGVzCiMKIyBDb21waWxlZCBieSBDeW5ndWxhciBTZWN1cml0eQojCgojIFJlbW92ZSBhbnkgZXhpc3RpbmcgcnVsZXMKLUQKCiMgQnVmZmVyIFNpemUKIyMgRmVlbCBmcmVlIHRvIGluY3JlYXNlIHRoaXMgaWYgdGhlIG1hY2hpbmUgcGFuaWMncwotYiA4MTkyCgojIEZhaWx1cmUgTW9kZQojIyBQb3NzaWJsZSB2YWx1ZXM6IDAgKHNpbGVudCksIDEgKHByaW50aywgcHJpbnQgYSBmYWlsdXJlIG1lc3NhZ2UpLCAyIChwYW5pYywgaGFsdCB0aGUgc3lzdGVtKQotZiAxCgojIElnbm9yZSBlcnJvcnMKIyMgZS5nLiBjYXVzZWQgYnkgdXNlcnMgb3IgZmlsZXMgbm90IGZvdW5kIGluIHRoZSBsb2NhbCBlbnZpcm9ubWVudAotaQoKIyBTZWxmIEF1ZGl0aW5nIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKIyMgQXVkaXQgdGhlIGF1ZGl0IGxvZ3MKIyMjIFN1Y2Nlc3NmdWwgYW5kIHVuc3VjY2Vzc2Z1bCBhdHRlbXB0cyB0byByZWFkIGluZm9ybWF0aW9uIGZyb20gdGhlIGF1ZGl0IHJlY29yZHMKLXcgL3Zhci9sb2cvYXVkaXQvIC1rIGF1ZGl0bG9nCgojIyBBdWRpdGQgY29uZmlndXJhdGlvbgojIyMgTW9kaWZpY2F0aW9ucyB0byBhdWRpdCBjb25maWd1cmF0aW9uIHRoYXQgb2NjdXIgd2hpbGUgdGhlIGF1ZGl0IGNvbGxlY3Rpb24gZnVuY3Rpb25zIGFyZSBvcGVyYXRpbmcKLXcgL2V0Yy9hdWRpdC8gLXAgd2EgLWsgYXVkaXRjb25maWcKLXcgL2V0Yy9saWJhdWRpdC5jb25mIC1wIHdhIC1rIGF1ZGl0Y29uZmlnCi13IC9ldGMvYXVkaXNwLyAtcCB3YSAtayBhdWRpc3Bjb25maWcKCiMjIE1vbml0b3IgZm9yIHVzZSBvZiBhdWRpdCBtYW5hZ2VtZW50IHRvb2xzCi13IC9zYmluL2F1ZGl0Y3RsIC1wIHggLWsgYXVkaXR0b29scwotdyAvc2Jpbi9hdWRpdGQgLXAgeCAtayBhdWRpdHRvb2xzCi13IC91c3Ivc2Jpbi9hdWdlbnJ1bGVzIC1wIHggLWsgYXVkaXR0b29scwoKIyBGaWx0ZXJzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKIyMjIFdlIHB1dCB0aGVzZSBlYXJseSBiZWNhdXNlIGF1ZGl0IGlzIGEgZmlyc3QgbWF0Y2ggd2lucyBzeXN0ZW0uCgojIyBleGNsdWRlcwotYSBuZXZlcixleGl0IC1GIGV4ZT0vdXNyL3NiaW4vY3JvbiAtayBleGNsdWRlX2Nyb24KLWEgbmV2ZXIsZXhpdCAtRiBleGU9L3Vzci9iaW4vZHBrZyAtayBleGNsdWRlX2Rwa2cKCiMjIElnbm9yZSBTRUxpbnV4IEFWQyByZWNvcmRzCi1hIGFsd2F5cyxleGNsdWRlIC1GIG1zZ3R5cGU9QVZDCgojIyBJZ25vcmUgY3VycmVudCB3b3JraW5nIGRpcmVjdG9yeSByZWNvcmRzCi1hIGFsd2F5cyxleGNsdWRlIC1GIG1zZ3R5cGU9Q1dECgojIyBDcm9uIGpvYnMgZmlsbCB0aGUgbG9ncyB3aXRoIHN0dWZmIHdlIG5vcm1hbGx5IGRvbid0IHdhbnQgKHdvcmtzIHdpdGggU0VMaW51eCkKLWEgbmV2ZXIsdXNlciAtRiBzdWJqX3R5cGU9Y3JvbmRfdAotYSBuZXZlcixleGl0IC1GIHN1YmpfdHlwZT1jcm9uZF90CgojIyBUaGlzIHByZXZlbnRzIGNocm9ueSBmcm9tIG92ZXJ3aGVsbWluZyB0aGUgbG9ncwotYSBuZXZlcixleGl0IC1GIGFyY2g9YjY0IC1TIGFkanRpbWV4IC1GIGF1aWQ9dW5zZXQgLUYgdWlkPWNocm9ueSAtRiBzdWJqX3R5cGU9Y2hyb255ZF90CgojIyBUaGlzIGlzIG5vdCB2ZXJ5IGludGVyZXN0aW5nIGFuZCB3YXN0ZXMgYSBsb3Qgb2Ygc3BhY2UgaWYgdGhlIHNlcnZlciBpcyBwdWJsaWMgZmFjaW5nCi1hIGFsd2F5cyxleGNsdWRlIC1GIG1zZ3R5cGU9Q1JZUFRPX0tFWV9VU0VSCgojIyBWTVdhcmUgdG9vbHMKLWEgbmV2ZXIsZXhpdCAtRiBhcmNoPWIzMiAtUyBmb3JrIC1GIHN1Y2Nlc3M9MCAtRiBwYXRoPS91c3IvbGliL3Ztd2FyZS10b29scyAtRiBzdWJqX3R5cGU9aW5pdHJjX3QgLUYgZXhpdD0tMgotYSBuZXZlcixleGl0IC1GIGFyY2g9YjY0IC1TIGZvcmsgLUYgc3VjY2Vzcz0wIC1GIHBhdGg9L3Vzci9saWIvdm13YXJlLXRvb2xzIC1GIHN1YmpfdHlwZT1pbml0cmNfdCAtRiBleGl0PS0yCgojIyBIaWdoIFZvbHVtZSBFdmVudCBGaWx0ZXIgKGVzcGVjaWFsbHkgb24gTGludXggV29ya3N0YXRpb25zKQotYSBuZXZlcixleGl0IC1GIGFyY2g9YjMyIC1GIGRpcj0vZGV2L3NobSAtayBzaGFyZWRtZW1hY2Nlc3MKLWEgbmV2ZXIsZXhpdCAtRiBhcmNoPWI2NCAtRiBkaXI9L2Rldi9zaG0gLWsgc2hhcmVkbWVtYWNjZXNzCi1hIG5ldmVyLGV4aXQgLUYgYXJjaD1iMzIgLUYgZGlyPS92YXIvbG9jay9sdm0gLWsgbG9ja2x2bQotYSBuZXZlcixleGl0IC1GIGFyY2g9YjY0IC1GIGRpcj0vdmFyL2xvY2svbHZtIC1rIGxvY2tsdm0KCiMjIEZpbGVCZWF0IAotYSBuZXZlcixleGl0IC1GIGFyY2g9YjMyIC1GIHBhdGg9L29wdC9maWxlYmVhdCAtayBmaWxlYmVhdAotYSBuZXZlcixleGl0IC1GIGFyY2g9YjY0IC1GIHBhdGg9L29wdC9maWxlYmVhdCAtayBmaWxlYmVhdAoKIyMgTW9yZSBpbmZvcm1hdGlvbiBvbiBob3cgdG8gZmlsdGVyIGV2ZW50cwojIyMgaHR0cHM6Ly9hY2Nlc3MucmVkaGF0LmNvbS9zb2x1dGlvbnMvMjQ4MjIyMQoKIyBSdWxlcyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKIyMgS2VybmVsIHBhcmFtZXRlcnMKLXcgL2V0Yy9zeXNjdGwuY29uZiAtcCB3YSAtayBzeXNjdGwKLXcgL2V0Yy9zeXNjdGwuZCAtcCB3YSAtayBzeXNjdGwKCiMjIEtlcm5lbCBtb2R1bGUgbG9hZGluZyBhbmQgdW5sb2FkaW5nCi1hIGFsd2F5cyxleGl0IC1GIHBlcm09eCAtRiBhdWlkIT0tMSAtRiBwYXRoPS9zYmluL2luc21vZCAtayBtb2R1bGVzCi1hIGFsd2F5cyxleGl0IC1GIHBlcm09eCAtRiBhdWlkIT0tMSAtRiBwYXRoPS9zYmluL21vZHByb2JlIC1rIG1vZHVsZXMKLWEgYWx3YXlzLGV4aXQgLUYgcGVybT14IC1GIGF1aWQhPS0xIC1GIHBhdGg9L3NiaW4vcm1tb2QgLWsgbW9kdWxlcwotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBmaW5pdF9tb2R1bGUgLVMgaW5pdF9tb2R1bGUgLVMgZGVsZXRlX21vZHVsZSAtRiBhdWlkIT0tMSAtayBtb2R1bGVzCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIGZpbml0X21vZHVsZSAtUyBpbml0X21vZHVsZSAtUyBkZWxldGVfbW9kdWxlIC1GIGF1aWQhPS0xIC1rIG1vZHVsZXMKCiMjIE1vZHByb2JlIGNvbmZpZ3VyYXRpb24KLXcgL2V0Yy9tb2Rwcm9iZS5jb25mIC1wIHdhIC1rIG1vZHByb2JlCi13IC9ldGMvbW9kcHJvYmUuZCAtcCB3YSAtayBtb2Rwcm9iZQoKIyMgS0V4ZWMgdXNhZ2UgKGFsbCBhY3Rpb25zKQotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBrZXhlY19sb2FkIC1rIEtFWEVDCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIHN5c19rZXhlY19sb2FkIC1rIEtFWEVDCgojIyBTcGVjaWFsIGZpbGVzCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIG1rbm9kIC1TIG1rbm9kYXQgLWsgc3BlY2lhbGZpbGVzCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIG1rbm9kIC1TIG1rbm9kYXQgLWsgc3BlY2lhbGZpbGVzCgojIyBNb3VudCBvcGVyYXRpb25zIChvbmx5IGF0dHJpYnV0YWJsZSkKLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iNjQgLVMgbW91bnQgLVMgdW1vdW50MiAtRiBhdWlkIT0tMSAtayBtb3VudAotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWIzMiAtUyBtb3VudCAtUyB1bW91bnQgLVMgdW1vdW50MiAtRiBhdWlkIT0tMSAtayBtb3VudAoKIyMgQ2hhbmdlIHN3YXAgKG9ubHkgYXR0cmlidXRhYmxlKQotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBzd2Fwb24gLVMgc3dhcG9mZiAtRiBhdWlkIT0tMSAtayBzd2FwCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIHN3YXBvbiAtUyBzd2Fwb2ZmIC1GIGF1aWQhPS0xIC1rIHN3YXAKCiMjIFRpbWUKIy1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1GIHVpZCE9bnRwIC1TIGFkanRpbWV4IC1TIHNldHRpbWVvZmRheSAtUyBjbG9ja19zZXR0aW1lIC1rIHRpbWUKIy1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1GIHVpZCE9bnRwIC1TIGFkanRpbWV4IC1TIHNldHRpbWVvZmRheSAtUyBjbG9ja19zZXR0aW1lIC1rIHRpbWUKIyMjIExvY2FsIHRpbWUgem9uZQojLXcgL2V0Yy9sb2NhbHRpbWUgLXAgd2EgLWsgbG9jYWx0aW1lCgojIyBTdHVubmVsCi13IC91c3Ivc2Jpbi9zdHVubmVsIC1wIHggLWsgc3R1bm5lbAotdyAvdXNyL2Jpbi9zdHVubmVsIC1wIHggLWsgc3R1bm5lbAoKIyMgQ3JvbiBjb25maWd1cmF0aW9uICYgc2NoZWR1bGVkIGpvYnMKLXcgL2V0Yy9jcm9uLmFsbG93IC1wIHdhIC1rIGNyb24KLXcgL2V0Yy9jcm9uLmRlbnkgLXAgd2EgLWsgY3JvbgotdyAvZXRjL2Nyb24uZC8gLXAgd2EgLWsgY3JvbgotdyAvZXRjL2Nyb24uZGFpbHkvIC1wIHdhIC1rIGNyb24KLXcgL2V0Yy9jcm9uLmhvdXJseS8gLXAgd2EgLWsgY3JvbgotdyAvZXRjL2Nyb24ubW9udGhseS8gLXAgd2EgLWsgY3JvbgotdyAvZXRjL2Nyb24ud2Vla2x5LyAtcCB3YSAtayBjcm9uCi13IC9ldGMvY3JvbnRhYiAtcCB3YSAtayBjcm9uCi13IC92YXIvc3Bvb2wvY3Jvbi8gLWsgY3JvbgoKIyMgVXNlciwgZ3JvdXAsIHBhc3N3b3JkIGRhdGFiYXNlcwotdyAvZXRjL2dyb3VwIC1wIHdhIC1rIGV0Y2dyb3VwCi13IC9ldGMvcGFzc3dkIC1wIHdhIC1rIGV0Y3Bhc3N3ZAotdyAvZXRjL2dzaGFkb3cgLWsgZXRjZ3JvdXAKLXcgL2V0Yy9zaGFkb3cgLWsgZXRjcGFzc3dkCi13IC9ldGMvc2VjdXJpdHkvb3Bhc3N3ZCAtayBvcGFzc3dkCgojIyBTdWRvZXJzIGZpbGUgY2hhbmdlcwotdyAvZXRjL3N1ZG9lcnMgLXAgd2EgLWsgYWN0aW9ucwotdyAvZXRjL3N1ZG9lcnMuZC8gLXAgd2EgLWsgYWN0aW9ucwoKIyMgUGFzc3dkCi13IC91c3IvYmluL3Bhc3N3ZCAtcCB4IC1rIHBhc3N3ZF9tb2RpZmljYXRpb24KCiMjIFRvb2xzIHRvIGNoYW5nZSBncm91cCBpZGVudGlmaWVycwotdyAvdXNyL3NiaW4vZ3JvdXBhZGQgLXAgeCAtayBncm91cF9tb2RpZmljYXRpb24KLXcgL3Vzci9zYmluL2dyb3VwbW9kIC1wIHggLWsgZ3JvdXBfbW9kaWZpY2F0aW9uCi13IC91c3Ivc2Jpbi9hZGRncm91cCAtcCB4IC1rIGdyb3VwX21vZGlmaWNhdGlvbgotdyAvdXNyL3NiaW4vdXNlcmFkZCAtcCB4IC1rIHVzZXJfbW9kaWZpY2F0aW9uCi13IC91c3Ivc2Jpbi91c2VyZGVsIC1wIHggLWsgdXNlcl9tb2RpZmljYXRpb24KLXcgL3Vzci9zYmluL3VzZXJtb2QgLXAgeCAtayB1c2VyX21vZGlmaWNhdGlvbgotdyAvdXNyL3NiaW4vYWRkdXNlciAtcCB4IC1rIHVzZXJfbW9kaWZpY2F0aW9uCgojIyBMb2dpbiBjb25maWd1cmF0aW9uIGFuZCBpbmZvcm1hdGlvbgotdyAvZXRjL2xvZ2luLmRlZnMgLXAgd2EgLWsgbG9naW4KLXcgL2V0Yy9zZWN1cmV0dHkgLXAgd2EgLWsgbG9naW4KLXcgL3Zhci9sb2cvZmFpbGxvZyAtcCB3YSAtayBsb2dpbgotdyAvdmFyL2xvZy9sYXN0bG9nIC1wIHdhIC1rIGxvZ2luCi13IC92YXIvbG9nL3RhbGx5bG9nIC1wIHdhIC1rIGxvZ2luCgojIyBOZXR3b3JrIEVudmlyb25tZW50CiMjIyBDaGFuZ2VzIHRvIGhvc3RuYW1lCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIHNldGhvc3RuYW1lIC1TIHNldGRvbWFpbm5hbWUgLWsgbmV0d29ya19tb2RpZmljYXRpb25zCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIHNldGhvc3RuYW1lIC1TIHNldGRvbWFpbm5hbWUgLWsgbmV0d29ya19tb2RpZmljYXRpb25zCgojIyMgU3VjY2Vzc2Z1bCBJUHY0IENvbm5lY3Rpb25zCiMtYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBjb25uZWN0IC1GIGEyPTE2IC1GIHN1Y2Nlc3M9MSAtRiBrZXk9bmV0d29ya19jb25uZWN0XzQKIy1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIGNvbm5lY3QgLUYgYTI9MTYgLUYgc3VjY2Vzcz0xIC1GIGtleT1uZXR3b3JrX2Nvbm5lY3RfNAoKIyMjIFN1Y2Nlc3NmdWwgSVB2NiBDb25uZWN0aW9ucwojLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iNjQgLVMgY29ubmVjdCAtRiBhMj0yOCAtRiBzdWNjZXNzPTEgLUYga2V5PW5ldHdvcmtfY29ubmVjdF82CiMtYSBhbHdheXMsZXhpdCAtRiBhcmNoPWIzMiAtUyBjb25uZWN0IC1GIGEyPTI4IC1GIHN1Y2Nlc3M9MSAtRiBrZXk9bmV0d29ya19jb25uZWN0XzYKCiMjIyBDaGFuZ2VzIHRvIG90aGVyIGZpbGVzCi13IC9ldGMvaG9zdHMgLXAgd2EgLWsgbmV0d29ya19tb2RpZmljYXRpb25zCi13IC9ldGMvc3lzY29uZmlnL25ldHdvcmsgLXAgd2EgLWsgbmV0d29ya19tb2RpZmljYXRpb25zCi13IC9ldGMvc3lzY29uZmlnL25ldHdvcmstc2NyaXB0cyAtcCB3IC1rIG5ldHdvcmtfbW9kaWZpY2F0aW9ucwotdyAvZXRjL25ldHdvcmsvIC1wIHdhIC1rIG5ldHdvcmsKLWEgYWx3YXlzLGV4aXQgLUYgZGlyPS9ldGMvTmV0d29ya01hbmFnZXIvIC1GIHBlcm09d2EgLWsgbmV0d29ya19tb2RpZmljYXRpb25zCgojIyMgQ2hhbmdlcyB0byBpc3N1ZQotdyAvZXRjL2lzc3VlIC1wIHdhIC1rIGV0Y2lzc3VlCi13IC9ldGMvaXNzdWUubmV0IC1wIHdhIC1rIGV0Y2lzc3VlCgojIyBTeXN0ZW0gc3RhcnR1cCBzY3JpcHRzCi13IC9ldGMvaW5pdHRhYiAtcCB3YSAtayBpbml0Ci13IC9ldGMvaW5pdC5kLyAtcCB3YSAtayBpbml0Ci13IC9ldGMvaW5pdC8gLXAgd2EgLWsgaW5pdAoKIyMgTGlicmFyeSBzZWFyY2ggcGF0aHMKLXcgL2V0Yy9sZC5zby5jb25mIC1wIHdhIC1rIGxpYnBhdGgKLXcgL2V0Yy9sZC5zby5jb25mLmQgLXAgd2EgLWsgbGlicGF0aAoKIyMgU3lzdGVtd2lkZSBsaWJyYXJ5IHByZWxvYWRzIChMRF9QUkVMT0FEKQotdyAvZXRjL2xkLnNvLnByZWxvYWQgLXAgd2EgLWsgc3lzdGVtd2lkZV9wcmVsb2FkcwoKIyMgUGFtIGNvbmZpZ3VyYXRpb24KLXcgL2V0Yy9wYW0uZC8gLXAgd2EgLWsgcGFtCi13IC9ldGMvc2VjdXJpdHkvbGltaXRzLmNvbmYgLXAgd2EgIC1rIHBhbQotdyAvZXRjL3NlY3VyaXR5L2xpbWl0cy5kIC1wIHdhICAtayBwYW0KLXcgL2V0Yy9zZWN1cml0eS9wYW1fZW52LmNvbmYgLXAgd2EgLWsgcGFtCi13IC9ldGMvc2VjdXJpdHkvbmFtZXNwYWNlLmNvbmYgLXAgd2EgLWsgcGFtCi13IC9ldGMvc2VjdXJpdHkvbmFtZXNwYWNlLmQgLXAgd2EgLWsgcGFtCi13IC9ldGMvc2VjdXJpdHkvbmFtZXNwYWNlLmluaXQgLXAgd2EgLWsgcGFtCgojIyBNYWlsIGNvbmZpZ3VyYXRpb24KIy13IC9ldGMvYWxpYXNlcyAtcCB3YSAtayBtYWlsCiMtdyAvZXRjL3Bvc3RmaXgvIC1wIHdhIC1rIG1haWwKIy13IC9ldGMvZXhpbTQvIC1wIHdhIC1rIG1haWwKCiMjIFNTSCBjb25maWd1cmF0aW9uCi13IC9ldGMvc3NoL3NzaGRfY29uZmlnIC1rIHNzaGQKLXcgL2V0Yy9zc2gvc3NoZF9jb25maWcuZCAtayBzc2hkCgojIyByb290IHNzaCBrZXkgdGFtcGVyaW5nCi13IC9yb290Ly5zc2ggLXAgd2EgLWsgcm9vdGtleQoKIyBTeXN0ZW1kCi13IC9iaW4vc3lzdGVtY3RsIC1wIHggLWsgc3lzdGVtZAotdyAvZXRjL3N5c3RlbWQvIC1wIHdhIC1rIHN5c3RlbWQKCiMjIFNFTGludXggZXZlbnRzIHRoYXQgbW9kaWZ5IHRoZSBzeXN0ZW0ncyBNYW5kYXRvcnkgQWNjZXNzIENvbnRyb2xzIChNQUMpCi13IC9ldGMvc2VsaW51eC8gLXAgd2EgLWsgbWFjX3BvbGljeQoKIyMgQ3JpdGljYWwgZWxlbWVudHMgYWNjZXNzIGZhaWx1cmVzCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIG9wZW4gLUYgZGlyPS9ldGMgLUYgc3VjY2Vzcz0wIC1rIHVuYXV0aGVkZmlsZWFjY2VzcwotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBvcGVuIC1GIGRpcj0vYmluIC1GIHN1Y2Nlc3M9MCAtayB1bmF1dGhlZGZpbGVhY2Nlc3MKLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iNjQgLVMgb3BlbiAtRiBkaXI9L3NiaW4gLUYgc3VjY2Vzcz0wIC1rIHVuYXV0aGVkZmlsZWFjY2VzcwotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBvcGVuIC1GIGRpcj0vdXNyL2JpbiAtRiBzdWNjZXNzPTAgLWsgdW5hdXRoZWRmaWxlYWNjZXNzCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIG9wZW4gLUYgZGlyPS91c3Ivc2JpbiAtRiBzdWNjZXNzPTAgLWsgdW5hdXRoZWRmaWxlYWNjZXNzCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIG9wZW4gLUYgZGlyPS92YXIgLUYgc3VjY2Vzcz0wIC1rIHVuYXV0aGVkZmlsZWFjY2VzcwotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBvcGVuIC1GIGRpcj0vaG9tZSAtRiBzdWNjZXNzPTAgLWsgdW5hdXRoZWRmaWxlYWNjZXNzCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIG9wZW4gLUYgZGlyPS9zcnYgLUYgc3VjY2Vzcz0wIC1rIHVuYXV0aGVkZmlsZWFjY2VzcwoKIyMgUHJvY2VzcyBJRCBjaGFuZ2UgKHN3aXRjaGluZyBhY2NvdW50cykgYXBwbGljYXRpb25zCi13IC9iaW4vc3UgLXAgeCAtayBwcml2X2VzYwotdyAvdXNyL2Jpbi9zdWRvIC1wIHggLWsgcHJpdl9lc2MKLXcgL2V0Yy9zdWRvZXJzIC1wIHJ3IC1rIHByaXZfZXNjCi13IC9ldGMvc3Vkb2Vycy5kIC1wIHJ3IC1rIHByaXZfZXNjCgojIyBQb3dlciBzdGF0ZQotdyAvc2Jpbi9zaHV0ZG93biAtcCB4IC1rIHBvd2VyCi13IC9zYmluL3Bvd2Vyb2ZmIC1wIHggLWsgcG93ZXIKLXcgL3NiaW4vcmVib290IC1wIHggLWsgcG93ZXIKLXcgL3NiaW4vaGFsdCAtcCB4IC1rIHBvd2VyCgojIyBTZXNzaW9uIGluaXRpYXRpb24gaW5mb3JtYXRpb24KLXcgL3Zhci9ydW4vdXRtcCAtcCB3YSAtayBzZXNzaW9uCi13IC92YXIvbG9nL2J0bXAgLXAgd2EgLWsgc2Vzc2lvbgotdyAvdmFyL2xvZy93dG1wIC1wIHdhIC1rIHNlc3Npb24KCiMjIERpc2NyZXRpb25hcnkgQWNjZXNzIENvbnRyb2wgKERBQykgbW9kaWZpY2F0aW9ucwotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWIzMiAtUyBjaG1vZCAtRiBhdWlkPj0xMDAwIC1GIGF1aWQhPS0xIC1rIHBlcm1fbW9kCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIGNob3duIC1GIGF1aWQ+PTEwMDAgLUYgYXVpZCE9LTEgLWsgcGVybV9tb2QKLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iMzIgLVMgZmNobW9kIC1GIGF1aWQ+PTEwMDAgLUYgYXVpZCE9LTEgLWsgcGVybV9tb2QKLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iMzIgLVMgZmNobW9kYXQgLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBwZXJtX21vZAotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWIzMiAtUyBmY2hvd24gLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBwZXJtX21vZAotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWIzMiAtUyBmY2hvd25hdCAtRiBhdWlkPj0xMDAwIC1GIGF1aWQhPS0xIC1rIHBlcm1fbW9kCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIGZyZW1vdmV4YXR0ciAtRiBhdWlkPj0xMDAwIC1GIGF1aWQhPS0xIC1rIHBlcm1fbW9kCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIGZzZXR4YXR0ciAtRiBhdWlkPj0xMDAwIC1GIGF1aWQhPS0xIC1rIHBlcm1fbW9kCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIGxjaG93biAtRiBhdWlkPj0xMDAwIC1GIGF1aWQhPS0xIC1rIHBlcm1fbW9kCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIGxyZW1vdmV4YXR0ciAtRiBhdWlkPj0xMDAwIC1GIGF1aWQhPS0xIC1rIHBlcm1fbW9kCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIGxzZXR4YXR0ciAtRiBhdWlkPj0xMDAwIC1GIGF1aWQhPS0xIC1rIHBlcm1fbW9kCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIHJlbW92ZXhhdHRyIC1GIGF1aWQ+PTEwMDAgLUYgYXVpZCE9LTEgLWsgcGVybV9tb2QKLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iMzIgLVMgc2V0eGF0dHIgLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBwZXJtX21vZAotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBjaG1vZCAgLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBwZXJtX21vZAotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBjaG93biAtRiBhdWlkPj0xMDAwIC1GIGF1aWQhPS0xIC1rIHBlcm1fbW9kCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIGZjaG1vZCAtRiBhdWlkPj0xMDAwIC1GIGF1aWQhPS0xIC1rIHBlcm1fbW9kCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIGZjaG1vZGF0IC1GIGF1aWQ+PTEwMDAgLUYgYXVpZCE9LTEgLWsgcGVybV9tb2QKLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iNjQgLVMgZmNob3duIC1GIGF1aWQ+PTEwMDAgLUYgYXVpZCE9LTEgLWsgcGVybV9tb2QKLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iNjQgLVMgZmNob3duYXQgLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBwZXJtX21vZAotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBmcmVtb3ZleGF0dHIgLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBwZXJtX21vZAotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBmc2V0eGF0dHIgLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBwZXJtX21vZAotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBsY2hvd24gLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBwZXJtX21vZAotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBscmVtb3ZleGF0dHIgLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBwZXJtX21vZAotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBsc2V0eGF0dHIgLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBwZXJtX21vZAotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyByZW1vdmV4YXR0ciAtRiBhdWlkPj0xMDAwIC1GIGF1aWQhPS0xIC1rIHBlcm1fbW9kCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIHNldHhhdHRyIC1GIGF1aWQ+PTEwMDAgLUYgYXVpZCE9LTEgLWsgcGVybV9tb2QKCiMgU3BlY2lhbCBSdWxlcyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiMjIFJlY29ubmFpc3NhbmNlCi13IC91c3IvYmluL3dob2FtaSAtcCB4IC1rIHJlY29uCi13IC91c3IvYmluL2lkIC1wIHggLWsgcmVjb24KLXcgL2Jpbi9ob3N0bmFtZSAtcCB4IC1rIHJlY29uCi13IC9iaW4vdW5hbWUgLXAgeCAtayByZWNvbgotdyAvZXRjL2lzc3VlIC1wIHIgLWsgcmVjb24KLXcgL2V0Yy9ob3N0bmFtZSAtcCByIC1rIHJlY29uCgojIyBTdXNwaWNpb3VzIGFjdGl2aXR5Ci13IC91c3IvYmluL3dnZXQgLXAgeCAtayBzdXNwX2FjdGl2aXR5Ci13IC91c3IvYmluL2N1cmwgLXAgeCAtayBzdXNwX2FjdGl2aXR5Ci13IC91c3IvYmluL2Jhc2U2NCAtcCB4IC1rIHN1c3BfYWN0aXZpdHkKLXcgL2Jpbi9uYyAtcCB4IC1rIHN1c3BfYWN0aXZpdHkKLXcgL2Jpbi9uZXRjYXQgLXAgeCAtayBzdXNwX2FjdGl2aXR5Ci13IC91c3IvYmluL25jYXQgLXAgeCAtayBzdXNwX2FjdGl2aXR5Ci13IC91c3IvYmluL3NzaCAtcCB4IC1rIHN1c3BfYWN0aXZpdHkKLXcgL3Vzci9iaW4vc2NwIC1wIHggLWsgc3VzcF9hY3Rpdml0eQotdyAvdXNyL2Jpbi9zZnRwIC1wIHggLWsgc3VzcF9hY3Rpdml0eQotdyAvdXNyL2Jpbi9mdHAgLXAgeCAtayBzdXNwX2FjdGl2aXR5Ci13IC91c3IvYmluL3NvY2F0IC1wIHggLWsgc3VzcF9hY3Rpdml0eQotdyAvdXNyL2Jpbi93aXJlc2hhcmsgLXAgeCAtayBzdXNwX2FjdGl2aXR5Ci13IC91c3IvYmluL3RzaGFyayAtcCB4IC1rIHN1c3BfYWN0aXZpdHkKLXcgL3Vzci9iaW4vcmF3c2hhcmsgLXAgeCAtayBzdXNwX2FjdGl2aXR5Ci13IC91c3IvYmluL3JkZXNrdG9wIC1wIHggLWsgc3VzcF9hY3Rpdml0eQotdyAvdXNyL2Jpbi9ubWFwIC1wIHggLWsgc3VzcF9hY3Rpdml0eQoKIyMgQWRkZWQgdG8gY2F0Y2ggbmV0Y2F0IG9uIFVidW50dQotdyAvYmluL25jLm9wZW5ic2QgLXAgeCAtayBzdXNwX2FjdGl2aXR5Ci13IC9iaW4vbmMudHJhZGl0aW9uYWwgLXAgeCAtayBzdXNwX2FjdGl2aXR5CgojIyBTYmluIHN1c3BpY2lvdXMgYWN0aXZpdHkKLXcgL3NiaW4vaXB0YWJsZXMgLXAgeCAtayBzYmluX3N1c3AKLXcgL3NiaW4vaXA2dGFibGVzIC1wIHggLWsgc2Jpbl9zdXNwCi13IC9zYmluL2lmY29uZmlnIC1wIHggLWsgc2Jpbl9zdXNwCi13IC91c3Ivc2Jpbi9hcnB0YWJsZXMgLXAgeCAtayBzYmluX3N1c3AKLXcgL3Vzci9zYmluL2VidGFibGVzIC1wIHggLWsgc2Jpbl9zdXNwCi13IC9zYmluL3h0YWJsZXMtbmZ0LW11bHRpIC1wIHggLWsgc2Jpbl9zdXNwCi13IC91c3Ivc2Jpbi9uZnQgLXAgeCAtayBzYmluX3N1c3AKLXcgL3Vzci9zYmluL3RjcGR1bXAgLXAgeCAtayBzYmluX3N1c3AKLXcgL3Vzci9zYmluL3RyYWNlcm91dGUgLXAgeCAtayBzYmluX3N1c3AKLXcgL3Vzci9zYmluL3VmdyAtcCB4IC1rIHNiaW5fc3VzcAoKIyMgZGJ1cy1zZW5kIGludm9jYXRpb24KIyMjIG1heSBpbmRpY2F0ZSBwcml2aWxlZ2UgZXNjYWxhdGlvbiBDVkUtMjAyMS0zNTYwCi13IC91c3IvYmluL2RidXMtc2VuZCAtcCB4IC1rIGRidXNfc2VuZAoKIyMgcGtleGVjIGludm9jYXRpb24KIyMjIG1heSBpbmRpY2F0ZSBwcml2aWxlZ2UgZXNjYWxhdGlvbiBDVkUtMjAyMS00MDM0Ci13IC91c3IvYmluL3BrZXhlYyAtcCB4IC1rIHBrZXhlYwoKIyMgU3VzcGljaW91cyBzaGVsbHMKIy13IC9iaW4vYXNoIC1wIHggLWsgc3VzcF9zaGVsbAojLXcgL2Jpbi9iYXNoIC1wIHggLWsgc3VzcF9zaGVsbAojLXcgL2Jpbi9jc2ggLXAgeCAtayBzdXNwX3NoZWxsCiMtdyAvYmluL2Rhc2ggLXAgeCAtayBzdXNwX3NoZWxsCiMtdyAvYmluL2J1c3lib3ggLXAgeCAtayBzdXNwX3NoZWxsCiMtdyAvYmluL2tzaCAtcCB4IC1rIHN1c3Bfc2hlbGwKIy13IC9iaW4vZmlzaCAtcCB4IC1rIHN1c3Bfc2hlbGwKIy13IC9iaW4vdGNzaCAtcCB4IC1rIHN1c3Bfc2hlbGwKIy13IC9iaW4vdGNsc2ggLXAgeCAtayBzdXNwX3NoZWxsCiMtdyAvYmluL3pzaCAtcCB4IC1rIHN1c3Bfc2hlbGwKCiMjIFNoZWxsL3Byb2ZpbGUgY29uZmlndXJhdGlvbnMKLXcgL2V0Yy9wcm9maWxlLmQvIC1wIHdhIC1rIHNoZWxsX3Byb2ZpbGVzCi13IC9ldGMvcHJvZmlsZSAtcCB3YSAtayBzaGVsbF9wcm9maWxlcwotdyAvZXRjL3NoZWxscyAtcCB3YSAtayBzaGVsbF9wcm9maWxlcwotdyAvZXRjL2Jhc2hyYyAtcCB3YSAtayBzaGVsbF9wcm9maWxlcwotdyAvZXRjL2NzaC5jc2hyYyAtcCB3YSAtayBzaGVsbF9wcm9maWxlcwotdyAvZXRjL2NzaC5sb2dpbiAtcCB3YSAtayBzaGVsbF9wcm9maWxlcwotdyAvZXRjL2Zpc2gvIC1wIHdhIC1rIHNoZWxsX3Byb2ZpbGVzCi13IC9ldGMvenNoLyAtcCB3YSAtayBzaGVsbF9wcm9maWxlcwoKIyMgSW5qZWN0aW9uCiMjIyBUaGVzZSBydWxlcyB3YXRjaCBmb3IgY29kZSBpbmplY3Rpb24gYnkgdGhlIHB0cmFjZSBmYWNpbGl0eS4KIyMjIFRoaXMgY291bGQgaW5kaWNhdGUgc29tZW9uZSB0cnlpbmcgdG8gZG8gc29tZXRoaW5nIGJhZCBvciBqdXN0IGRlYnVnZ2luZwotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWIzMiAtUyBwdHJhY2UgLUYgYTA9MHg0IC1rIGNvZGVfaW5qZWN0aW9uCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIHB0cmFjZSAtRiBhMD0weDQgLWsgY29kZV9pbmplY3Rpb24KLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iMzIgLVMgcHRyYWNlIC1GIGEwPTB4NSAtayBkYXRhX2luamVjdGlvbgotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBwdHJhY2UgLUYgYTA9MHg1IC1rIGRhdGFfaW5qZWN0aW9uCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIHB0cmFjZSAtRiBhMD0weDYgLWsgcmVnaXN0ZXJfaW5qZWN0aW9uCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIHB0cmFjZSAtRiBhMD0weDYgLWsgcmVnaXN0ZXJfaW5qZWN0aW9uCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIHB0cmFjZSAtayB0cmFjaW5nCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIHB0cmFjZSAtayB0cmFjaW5nCgojIyBBbm9ueW1vdXMgRmlsZSBDcmVhdGlvbgojIyMgVGhlc2UgcnVsZXMgd2F0Y2ggdGhlIHVzZSBvZiBtZW1mZF9jcmVhdGUgCiMjIyAibWVtZmRfY3JlYXRlIiBjcmVhdGVzIGFub255bW91cyBmaWxlIGFuZCByZXR1cm5zIGEgZmlsZSBkZXNjcmlwdG9yIHRvIGFjY2VzcyBpdAojIyMgV2hlbiBjb21iaW5lZCB3aXRoICJmZXhlY3ZlIiBjYW4gYmUgdXNlZCB0byBzdGVhbHRoaWx5IHJ1biBiaW5hcmllcyBpbiBtZW1vcnkgd2l0aG91dCB0b3VjaGluZyBkaXNrICAKLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iNjQgLVMgbWVtZmRfY3JlYXRlIC1GIGtleT1hbm9uX2ZpbGVfY3JlYXRlCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIG1lbWZkX2NyZWF0ZSAtRiBrZXk9YW5vbl9maWxlX2NyZWF0ZSAgICAgIAoKCiMjIFByaXZpbGVnZSBBYnVzZQojIyMgVGhlIHB1cnBvc2Ugb2YgdGhpcyBydWxlIGlzIHRvIGRldGVjdCB3aGVuIGFuIGFkbWluIG1heSBiZSBhYnVzaW5nIHBvd2VyIGJ5IGxvb2tpbmcgaW4gdXNlcidzIGhvbWUgZGlyLgotYSBhbHdheXMsZXhpdCAtRiBkaXI9L2hvbWUgLUYgdWlkPTAgLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtQyBhdWlkIT1vYmpfdWlkIC1rIHBvd2VyX2FidXNlCgojIFNvZnR3YXJlIE1hbmFnZW1lbnQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgojIFJQTSAoUmVkaGF0L0NlbnRPUykKIy13IC91c3IvYmluL3JwbSAtcCB4IC1rIHNvZnR3YXJlX21nbXQKIy13IC91c3IvYmluL3l1bSAtcCB4IC1rIHNvZnR3YXJlX21nbXQKCiMgRE5GIChGZWRvcmEvUmVkSGF0IDgvQ2VudE9TIDgpCiMtdyAvdXNyL2Jpbi9kbmYgLXAgeCAtayBzb2Z0d2FyZV9tZ210CgojIFlBU1QvWnlwcGVyL1JQTSAoU3VTRSkKIy13IC9zYmluL3lhc3QgLXAgeCAtayBzb2Z0d2FyZV9tZ210CiMtdyAvc2Jpbi95YXN0MiAtcCB4IC1rIHNvZnR3YXJlX21nbXQKIy13IC9iaW4vcnBtIC1wIHggLWsgc29mdHdhcmVfbWdtdAojLXcgL3Vzci9iaW4venlwcGVyIC1rIHNvZnR3YXJlX21nbXQKCiMgRFBLRyAvIEFQVC1HRVQgKERlYmlhbi9VYnVudHUpCiMtdyAvdXNyL2Jpbi9kcGtnIC1wIHggLWsgc29mdHdhcmVfbWdtdAojLXcgL3Vzci9iaW4vYXB0IC1wIHggLWsgc29mdHdhcmVfbWdtdAojLXcgL3Vzci9iaW4vYXB0LWFkZC1yZXBvc2l0b3J5IC1wIHggLWsgc29mdHdhcmVfbWdtdAojLXcgL3Vzci9iaW4vYXB0LWdldCAtcCB4IC1rIHNvZnR3YXJlX21nbXQKIy13IC91c3IvYmluL2FwdGl0dWRlIC1wIHggLWsgc29mdHdhcmVfbWdtdAojLXcgL3Vzci9iaW4vd2FqaWcgLXAgeCAtayBzb2Z0d2FyZV9tZ210CiMtdyAvdXNyL2Jpbi9zbmFwIC1wIHggLWsgc29mdHdhcmVfbWdtdAoKIyBQSVAgKFB5dGhvbiBpbnN0YWxscykKIy13IC91c3IvYmluL3BpcCAtcCB4IC1rIHNvZnR3YXJlX21nbXQKIy13IC91c3IvYmluL3BpcDMgLXAgeCAtayBzb2Z0d2FyZV9tZ210CgojIFNwZWNpYWwgU29mdHdhcmUgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgojIyBHRFMgc3BlY2lmaWMgc2VjcmV0cwotdyAvZXRjL3B1cHBldC9zc2wgLXAgd2EgLWsgcHVwcGV0X3NzbAoKIyMgSUJNIEJpZ2ZpeCBCRVNDbGllbnQKLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iNjQgLVMgb3BlbiAtRiBkaXI9L29wdC9CRVNDbGllbnQgLUYgc3VjY2Vzcz0wIC1rIHNvZnRfYmVzY2xpZW50Ci13IC92YXIvb3B0L0JFU0NsaWVudC8gLXAgd2EgLWsgc29mdF9iZXNjbGllbnQKCiMjIENIRUYgaHR0cHM6Ly93d3cuY2hlZi5pby9jaGVmLwotdyAvZXRjL2NoZWYgLXAgd2EgLWsgc29mdF9jaGVmCgojIyBEb2NrZXIKIy13IC91c3IvYmluL2RvY2tlcmQgLWsgZG9ja2VyCiMtdyAvdXNyL2Jpbi9kb2NrZXIgLWsgZG9ja2VyCiMtdyAvdXNyL2Jpbi9kb2NrZXItY29udGFpbmVyZCAtayBkb2NrZXIKIy13IC91c3IvYmluL2RvY2tlci1ydW5jIC1rIGRvY2tlcgojLXcgL3Zhci9saWIvZG9ja2VyIC1rIGRvY2tlcgojLXcgL2V0Yy9kb2NrZXIgLWsgZG9ja2VyCiMtdyAvZXRjL3N5c2NvbmZpZy9kb2NrZXIgLWsgZG9ja2VyCiMtdyAvZXRjL3N5c2NvbmZpZy9kb2NrZXItc3RvcmFnZSAtayBkb2NrZXIKIy13IC91c3IvbGliL3N5c3RlbWQvc3lzdGVtL2RvY2tlci5zZXJ2aWNlIC1rIGRvY2tlcgoKIyMgS3ViZWxldAotdyAvdXNyL2Jpbi9rdWJlbGV0IC1rIGt1YmVsZXQKCiMgSGlnaCBWb2x1bWUgRXZlbnRzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiMjIFJlbW92ZSB0aGVtIGlmIHRoZXkgY2F1c2UgdG8gbXVjaCB2b2x1bWUgaW4geW91ciBlbnZpcm9ubWVudAoKIyMgUm9vdCBjb21tYW5kIGV4ZWN1dGlvbnMKLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iNjQgLUYgZXVpZD0wIC1TIGV4ZWN2ZSAtayByb290Y21kCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1GIGV1aWQ9MCAtUyBleGVjdmUgLWsgcm9vdGNtZAoKIyMgRmlsZSBEZWxldGlvbiBFdmVudHMgYnkgVXNlcgotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWIzMiAtUyBybWRpciAtUyB1bmxpbmsgLVMgdW5saW5rYXQgLVMgcmVuYW1lIC1TIHJlbmFtZWF0IC1GIGF1aWQ+PTEwMDAgLUYgYXVpZCE9LTEgLWsgZGVsZXRlCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIHJtZGlyIC1TIHVubGluayAtUyB1bmxpbmthdCAtUyByZW5hbWUgLVMgcmVuYW1lYXQgLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBkZWxldGUKCiMjIEZpbGUgQWNjZXNzCiMjIyBVbmF1dGhvcml6ZWQgQWNjZXNzICh1bnN1Y2Nlc3NmdWwpCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIGNyZWF0IC1TIG9wZW4gLVMgb3BlbmF0IC1TIG9wZW5fYnlfaGFuZGxlX2F0IC1TIHRydW5jYXRlIC1TIGZ0cnVuY2F0ZSAtRiBleGl0PS1FQUNDRVMgLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBmaWxlX2FjY2VzcwotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWIzMiAtUyBjcmVhdCAtUyBvcGVuIC1TIG9wZW5hdCAtUyBvcGVuX2J5X2hhbmRsZV9hdCAtUyB0cnVuY2F0ZSAtUyBmdHJ1bmNhdGUgLUYgZXhpdD0tRVBFUk0gLUYgYXVpZD49MTAwMCAtRiBhdWlkIT0tMSAtayBmaWxlX2FjY2VzcwotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBjcmVhdCAtUyBvcGVuIC1TIG9wZW5hdCAtUyBvcGVuX2J5X2hhbmRsZV9hdCAtUyB0cnVuY2F0ZSAtUyBmdHJ1bmNhdGUgLUYgZXhpdD0tRUFDQ0VTIC1GIGF1aWQ+PTEwMDAgLUYgYXVpZCE9LTEgLWsgZmlsZV9hY2Nlc3MKLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iNjQgLVMgY3JlYXQgLVMgb3BlbiAtUyBvcGVuYXQgLVMgb3Blbl9ieV9oYW5kbGVfYXQgLVMgdHJ1bmNhdGUgLVMgZnRydW5jYXRlIC1GIGV4aXQ9LUVQRVJNIC1GIGF1aWQ+PTEwMDAgLUYgYXVpZCE9LTEgLWsgZmlsZV9hY2Nlc3MKCiMjIyBVbnN1Y2Nlc3NmdWwgQ3JlYXRpb24KLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iMzIgLVMgY3JlYXQsbGluayxta25vZCxta2RpcixzeW1saW5rLG1rbm9kYXQsbGlua2F0LHN5bWxpbmthdCAtRiBleGl0PS1FQUNDRVMgLWsgZmlsZV9jcmVhdGlvbgotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyBta2RpcixjcmVhdCxsaW5rLHN5bWxpbmssbWtub2QsbWtub2RhdCxsaW5rYXQsc3ltbGlua2F0IC1GIGV4aXQ9LUVBQ0NFUyAtayBmaWxlX2NyZWF0aW9uCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjMyIC1TIGxpbmssbWtkaXIsc3ltbGluayxta2RpcmF0IC1GIGV4aXQ9LUVQRVJNIC1rIGZpbGVfY3JlYXRpb24KLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iNjQgLVMgbWtkaXIsbGluayxzeW1saW5rLG1rZGlyYXQgLUYgZXhpdD0tRVBFUk0gLWsgZmlsZV9jcmVhdGlvbgoKIyMjIFVuc3VjY2Vzc2Z1bCBNb2RpZmljYXRpb24KLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iMzIgLVMgcmVuYW1lIC1TIHJlbmFtZWF0IC1TIHRydW5jYXRlIC1TIGNobW9kIC1TIHNldHhhdHRyIC1TIGxzZXR4YXR0ciAtUyByZW1vdmV4YXR0ciAtUyBscmVtb3ZleGF0dHIgLUYgZXhpdD0tRUFDQ0VTIC1rIGZpbGVfbW9kaWZpY2F0aW9uCi1hIGFsd2F5cyxleGl0IC1GIGFyY2g9YjY0IC1TIHJlbmFtZSAtUyByZW5hbWVhdCAtUyB0cnVuY2F0ZSAtUyBjaG1vZCAtUyBzZXR4YXR0ciAtUyBsc2V0eGF0dHIgLVMgcmVtb3ZleGF0dHIgLVMgbHJlbW92ZXhhdHRyIC1GIGV4aXQ9LUVBQ0NFUyAtayBmaWxlX21vZGlmaWNhdGlvbgotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWIzMiAtUyByZW5hbWUgLVMgcmVuYW1lYXQgLVMgdHJ1bmNhdGUgLVMgY2htb2QgLVMgc2V0eGF0dHIgLVMgbHNldHhhdHRyIC1TIHJlbW92ZXhhdHRyIC1TIGxyZW1vdmV4YXR0ciAtRiBleGl0PS1FUEVSTSAtayBmaWxlX21vZGlmaWNhdGlvbgotYSBhbHdheXMsZXhpdCAtRiBhcmNoPWI2NCAtUyByZW5hbWUgLVMgcmVuYW1lYXQgLVMgdHJ1bmNhdGUgLVMgY2htb2QgLVMgc2V0eGF0dHIgLVMgbHNldHhhdHRyIC1TIHJlbW92ZXhhdHRyIC1TIGxyZW1vdmV4YXR0ciAtRiBleGl0PS1FUEVSTSAtayBmaWxlX21vZGlmaWNhdGlvbgoKIyMgMzJiaXQgQVBJIEV4cGxvaXRhdGlvbgojIyMgSWYgeW91IGFyZSBvbiBhIDY0IGJpdCBwbGF0Zm9ybSwgZXZlcnl0aGluZyBfc2hvdWxkXyBiZSBydW5uaW5nCiMjIyBpbiA2NCBiaXQgbW9kZS4gVGhpcyBydWxlIHdpbGwgZGV0ZWN0IGFueSB1c2Ugb2YgdGhlIDMyIGJpdCBzeXNjYWxscwojIyMgYmVjYXVzZSB0aGlzIG1pZ2h0IGJlIGEgc2lnbiBvZiBzb21lb25lIGV4cGxvaXRpbmcgYSBob2xlIGluIHRoZSAzMgojIyMgYml0IEFQSS4KLWEgYWx3YXlzLGV4aXQgLUYgYXJjaD1iMzIgLVMgYWxsIC1rIDMyYml0X2FwaQoKIyBNYWtlIFRoZSBDb25maWd1cmF0aW9uIEltbXV0YWJsZSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKIyMtZSAyCg=='
                    
#                     for instance_id in instance_ids:
#                         try:
#                             logging.info(f'CONFIGURING OS INTERNALS ON INSTANCE-ID: {instance_id}')
#                             response = ssm_client.send_command(
#                                         InstanceIds=[instance_id],
#                                         DocumentName="AWS-RunShellScript",
#                                         Parameters={'commands': ['apt-get update -y','apt-get install -y auditd','systemctl kill auditd.service', 'sleep 10', f'echo {auditd_rules} | base64 --decode > "/etc/audit/rules.d/audit.rules"', 'sleep 10','systemctl start auditd.service']
#                                                 }
#                                         )
#                             logging.info(f'COMMAND SUCCEEDED.')
#                         except Exception as e:
#                             pass
#                 except Exception as e:
#                     logging.critical(str(e))

#             def ekslogs(cur_region_name):
#                 try:
#                     logging.info('STARTING EKSLOGS...')
#                     wanted_cluster_logging_config = {
#                                                 'clusterLogging': [
#                                                     {
#                                                         'types': [
#                                                             'audit', 'authenticator'
#                                                         ],
#                                                         'enabled': True
#                                                     }
#                                                 ]
#                                             }

#                     eks_client = boto3.client('eks', region_name = cur_region_name)
#                     clusters = eks_client.list_clusters()['clusters']

#                     for cluster_name in clusters:
#                         logging.info(f'CONFIGURING EKSLOGS ON CLUSTER: {cluster_name}')
#                         try:
#                             eks_client.update_cluster_config(
#                                 name = cluster_name,
#                                 logging = wanted_cluster_logging_config
#                                 )
#                             logging.info(f'COMMAND SUCCEEDED.')
#                         except Exception as e:
#                             if 'No changes needed for the logging config provided' not in str(e):
#                                 logging.critical (f'COMMAND FAILED - {str(e)}')

#                 except Exception as e:
#                     logging.critical(str(e))

#             def dnslogs(cur_region_name):
#                 try:
#                     logging.info(f'STARTING DNSLOGS...')

#                     r_53 = boto3.client('route53resolver', region_name=cur_region_name)
#                     ec2 = boto3.client('ec2', region_name=cur_region_name)
                    
#                     region_query_log_configs = r_53.list_resolver_query_log_configs()['ResolverQueryLogConfigs']
#                     cyngular_resolver_id = ''
                    
#                     for region_query_log_config in region_query_log_configs:
#                         try:
#                             if region_query_log_config['Name'] == 'cyngular_dns':
#                                 cyngular_resolver_id = region_query_log_config['Id']
#                                 break
#                         except:
#                             pass

#                     if cyngular_resolver_id:
#                         vpc_list = ec2.describe_vpcs()
#                         if "Vpcs" in vpc_list:                  
#                             for vpc in vpc_list["Vpcs"]:
#                                 try:
#                                     vpc_id = vpc["VpcId"]
#                                     logging.info(f'CONFIGURING DNSLOGS ON VPC-ID: {vpc_id}')
#                                     resp = r_53.associate_resolver_query_log_config(ResolverQueryLogConfigId = cyngular_resolver_id, ResourceId = vpc_id )
#                                     logging.info(f'COMMAND SUCCEEDED.')
#                                 except Exception as e:
#                                     if 'already associated' in str(e):
#                                         logging.critical(f'{vpc_id} - ResolverAlreadyAssociated')
#                                     else:
#                                         logging.critical(str(e))
#                 except Exception as e:
#                     logging.critical(str(e))

#             def cyngular_function(event, context):
                
#                 try:
#                     logging.basicConfig(format='%(asctime)s - %(levelname)s - %(message)s', level=logging.INFO)
#                     logger = logging.getLogger()
#                     logger.setLevel(logging.INFO)
#                     logging.info('STRATING CYNGULARS FUNCTION...')
#                     func_lst = [osinternals, ekslogs, dnslogs]
#                     ec2_client = boto3.client('ec2')
#                     events_client=boto3.client('events')
#                     LAMBDA_REGIONS = os.environ['LAMBDA_REGIONS'].split(' ')
                    
#                     for curr_region in LAMBDA_REGIONS:
#                         logging.info(f'AWS REGION: {curr_region}')
#                         for func in func_lst:
#                             try:
#                                 func(curr_region)
#                             except Exception as e:
#                                 logging.critical(str(e))
#                     logging.info('ACTIVATING EVENT BUS RULE')
#                     response = events_client.put_rule(
#                         Name='cyngular-lambda-create-resources-rule',
#                         ScheduleExpression="cron(0 8 * * ? *)",
#                         State='ENABLED',
#                         Description='LambdaBScheduledRule',
#                         EventBusName='default'
#                     )
#                     logging.info('DONE!')

#                 except Exception as e:
#                     logging.critical(str(e))
#       Environment:
#         Variables:
#           LAMBDA_REGIONS: !Join [" ", !Ref ClientRegions] 
    
#       Runtime: "python3.9"
#       Handler: index.cyngular_function
#       Timeout: 300
#       Role: !GetAtt LambdasRole.Arn
  
#   LambdaAScheduledRule: 
#     Type: AWS::Events::Rule
#     Properties: 
#       Name: cyngular-lambda-create-resources-rule
#       Description: "LambdaAScheduledRule"
#       ScheduleExpression: "cron(*/30 * * * ? *)"
#       State: "ENABLED"
#       Targets: 
#         - Arn: !GetAtt CyngularLambdaA.Arn
#           Id: "TargetFunctionV1"

#   PermissionForEventsToInvokeLambdaA: 
#     Type: AWS::Lambda::Permission
#     Properties: 
#       FunctionName: !GetAtt CyngularLambdaA.Arn
#       Action: "lambda:InvokeFunction"
#       Principal: "events.amazonaws.com"
#       SourceArn: !GetAtt LambdaAScheduledRule.Arn

# #------------------Cyngular Lambda B-------------------
#   CyngularLambdaB:
#     Type: AWS::Lambda::Function
#     Properties:
#       FunctionName: cyngular-lambda-create-vpcflowlogs 
#       Description: Created by Cyngular Security.
#       Code:
#         ZipFile: !Sub | 
#             import boto3
#             import traceback
#             import os
#             import logging

#             def vpcflowlogs(cur_region_name):
#                 try:
#                     logging.info('STARTING VPCFLOWLOGS...')

#                     vpc_id_list = []
#                     ec2 = boto3.client('ec2', region_name=cur_region_name)
                                        
#                     vpc_list = ec2.describe_vpcs()
#                     if "Vpcs" in vpc_list:                  
#                         for vpc in vpc_list["Vpcs"]:
#                             vpc_id_list.append(vpc["VpcId"])

#                     logging.info(f'CONFIGURING VPCFLOWLOGS ON VPC-IDS: {vpc_id_list}')
#                     response = ec2.create_flow_logs(
#                         ResourceIds=vpc_id_list,
#                         ResourceType='VPC',
#                         TrafficType='ALL',
#                         LogDestinationType='s3',
#                         LogDestination='${CyngularS3Bucket.Arn}',
#                         TagSpecifications=[
#                             {
#                                 'ResourceType': 'vpc-flow-log',
#                                 'Tags': [
#                                     {
#                                         'Key': 'Name',
#                                         'Value': 'Cyngular-vpc-flowlogs'
#                                     },
#                                 ]
#                             },
#                         ]
#                     )
#                     logging.info(f'COMMAND SUCCEEDED.')

#                 except Exception as e:
#                     if 'FlowLogAlreadyExists' in str(e):
#                         pass
#                     else:
#                         logging.critical(str(e))

#             def cyngular_function(event, context):
                
#                 try:
#                     logging.basicConfig(format='%(asctime)s - %(levelname)s - %(message)s', level=logging.INFO)
#                     logger = logging.getLogger()
#                     logger.setLevel(logging.INFO)
#                     logging.info('STRATING CYNGULARS FUNCTION...')
#                     func_lst = [vpcflowlogs]
#                     ec2_client = boto3.client('ec2')
#                     events_client=boto3.client('events')
#                     regions = os.environ['LAMBDA_REGIONS'].split(' ')

#                     for cur_region_name in regions:
#                         logging.info(f'AWS REGION: {cur_region_name}')
#                         for func in func_lst:
#                             try:
#                                 func(cur_region_name)
#                             except Exception as e:
#                                 logging.critical(str(e))
#                     logging.info('ACTIVATING EVENT BUS RULE')
#                     response = events_client.put_rule(
#                         Name='cyngular-lambda-create-vpcflowlogs-rule',
#                         ScheduleExpression="cron(0 8 * * ? *)",
#                         State='ENABLED',
#                         Description='LambdaBScheduledRule',
#                         EventBusName='default'
#                     )
#                     logging.info('DONE!')

#                 except Exception as e:
#                     logging.critical(str(e))
#       Environment:
#         Variables:
#           LAMBDA_REGIONS: !Join [" ", !Ref ClientRegions]

#       Runtime: "python3.9"
#       Handler: index.cyngular_function
#       Timeout: 300
#       Role: !GetAtt LambdasRole.Arn
  
#   LambdaBScheduledRule: 
#     Type: AWS::Events::Rule
#     Properties: 
#       Name: cyngular-lambda-create-vpcflowlogs-rule
#       Description: "LambdaBScheduledRule"
#       ScheduleExpression: "cron(*/30 * * * ? *)"
#       State: "ENABLED"
#       Targets: 
#         - Arn: !GetAtt CyngularLambdaB.Arn
#           Id: "TargetFunctionV1"

#   PermissionForEventsToInvokeLambdaB: 
#     Type: AWS::Lambda::Permission
#     Properties: 
#       FunctionName: !GetAtt CyngularLambdaB.Arn
#       Action: "lambda:InvokeFunction"
#       Principal: "events.amazonaws.com"
#       SourceArn: !GetAtt LambdaBScheduledRule.Arn
  
# #------------------Cyngular Lambda C-------------------
#   CyngularLambdaC:
#     Type: AWS::Lambda::Function
#     Properties:
#       FunctionName: cyngular-lambda-delete-vpcflowlogs
#       Description: Created by Cyngular Security.
#       Code:
#         ZipFile: !Sub | 
#             import boto3
#             import traceback
#             import os
#             import logging

#             def vpcflowlogs(cur_region_name):
#                 try:
#                     logging.info('DELETING VPCFLOWLOGS...')

#                     flowlogs_ids_list = []
#                     ec2 = boto3.client('ec2', region_name=cur_region_name)
                    
#                     response = ec2.describe_flow_logs(
#                         Filters=[
#                                 {
#                                     'Name': 'tag:Name',
#                                     'Values': [
#                                         'Cyngular-vpc-flowlogs'
#                                     ]
#                                 },
#                             ]
#                         )
#                     # getting all the cyngular vpc flowlogs in curr region 
#                     for flow_log in response['FlowLogs']:
#                         flowlogs_ids_list.append(flow_log['FlowLogId'])
                    
#                     logging.info(f'DELETING THE VPCFLOWLOGS: {flowlogs_ids_list}')
#                     response = ec2.delete_flow_logs(
#                         FlowLogIds=flowlogs_ids_list
#                     )
#                     logging.info(f'COMMAND SUCCEEDED.')
#                 except Exception as e:
#                     logging.critical(str(e))
                    
#             def cyngular_function(event, context):
                
#                 try:
#                     logging.basicConfig(format='%(asctime)s - %(levelname)s - %(message)s', level=logging.INFO)
#                     logger = logging.getLogger()
#                     logger.setLevel(logging.INFO)
        
#                     logging.info('STRATING CYNGULARS FUNCTION...')
#                     func_lst = [vpcflowlogs]
#                     ec2_client = boto3.client('ec2')
#                     events_client = boto3.client('events')
#                     regions = os.environ['LAMBDA_REGIONS'].split(' ')

#                     for cur_region_name in regions:
#                         logging.info(f'AWS REGION: {cur_region_name}')
#                         for func in func_lst:
#                             try:
#                                 func(cur_region_name)
#                             except Exception as e:
#                                 logging.critical(str(e))
#                     logging.info('DEACTIVATING EVENT BUS RULE')
#                     response = events_client.disable_rule(
#                         Name='cyngular-lambda-create-vpcflowlogs-rule',
#                         EventBusName='default'
#                     )
#                     logging.info('DONE!')

#                 except Exception as e:
#                     logging.critical(str(e))
#       Environment:
#         Variables:
#           LAMBDA_REGIONS: !Join [" ", !Ref ClientRegions]

#       Runtime: "python3.9"
#       Handler: index.cyngular_function
#       Timeout: 300
#       Role: !GetAtt LambdasRole.Arn
  
#   CyngularLambdaD:
#     Type: AWS::Lambda::Function
#     Properties:
#       FunctionName: cyngular-lambda-delete-resources  
#       Description: Created by Cyngular Security.
#       Code:
#         ZipFile: !Sub | 
#             import boto3
#             import traceback
#             import os
#             import logging
            
#             def dnslogs(cur_region_name):
#                 try:
#                     logging.info(f'DELETING DNSLOGS...')

#                     r_53 = boto3.client('route53resolver', region_name=cur_region_name)
#                     ec2 = boto3.client('ec2', region_name=cur_region_name)
                    
#                     region_query_log_configs = r_53.list_resolver_query_log_configs()['ResolverQueryLogConfigs']
#                     cyngular_resolver_id = ''
                    
#                     for region_query_log_config in region_query_log_configs:
#                         try:
#                             if region_query_log_config['Name'] == 'cyngular_dns':
#                                 cyngular_resolver_id = region_query_log_config['Id']
#                                 break
#                         except:
#                             pass

#                     if cyngular_resolver_id:
#                         vpc_list = ec2.describe_vpcs()
#                         if "Vpcs" in vpc_list:                  
#                             for vpc in vpc_list["Vpcs"]:
#                                 try:
#                                     vpc_id = vpc["VpcId"]
#                                     logging.info (f'DELETING CONFIGURATION OF DNSLOGS ON VPC-ID: {vpc_id}')
#                                     resp = r_53.disassociate_resolver_query_log_config(ResolverQueryLogConfigId = cyngular_resolver_id, ResourceId = vpc_id )
#                                     logging.info(f'COMMAND SUCCEEDED.')
#                                 except Exception as e:
#                                     if "association doesn't exist" in str(e):
#                                         logging.critical(f'{vpc_id} - ResolverWasNotAssociated')
#                                     else:
#                                         logging.critical(str(e))
#                 except Exception as e:
#                     logging.critical(str(e))

#             def cyngular_function(event, context):
                
#                 try:
#                     logging.basicConfig(format='%(asctime)s - %(levelname)s - %(message)s', level=logging.INFO)
#                     logger = logging.getLogger()
#                     logger.setLevel(logging.INFO)
#                     logging.info ('STRATING CYNGULARS FUNCTION...')
#                     func_lst = [dnslogs]
#                     ec2_client = boto3.client('ec2')
#                     events_client = boto3.client('events')
#                     regions = os.environ['LAMBDA_REGIONS'].split(' ')

#                     for cur_region_name in regions:
#                         logging.info (f'AWS REGION: {cur_region_name}')
#                         for func in func_lst:
#                             try:
#                                 func(cur_region_name)
#                             except Exception as e:
#                                 logging.critical(str(e))
#                     logging.info('DEACTIVATING EVENT BUS RULE')
#                     response = events_client.disable_rule(
#                         Name='cyngular-lambda-create-resources-rule',
#                         EventBusName='default'
#                     )
#                     logging.info('DONE!')

#                 except Exception as e:
#                     logging.critical(str(e))
#       Environment:
#         Variables:
#           LAMBDA_REGIONS: !Join [" ", !Ref ClientRegions]

#       Runtime: "python3.9"
#       Handler: index.cyngular_function
#       Timeout: 300
#       Role: !GetAtt LambdasRole.Arn
  
  CyngularLambdaE:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: cyngular-lambda-update-cyngular-bucket
      Description: Created by Cyngular Security.
      Code:
        ZipFile: !Sub | 
            import boto3
            import traceback
            import os
            import logging
            import json

            def trigger_manager_lambda():
                lambda_client = boto3.client('lambda')
                response = lambda_client.invoke(
                    FunctionName='cyngular-lambda-manager-function',
                    InvocationType = 'RequestResponse',
                    LogType='Tail',
                    ClientContext='',
                )
            def get_account_ids_lst_by_organization():
                account_ids_lst = []

                try:
                    client = boto3.client('organizations')
                    response = client.list_accounts()
                  
                    if 'Accounts' in response:
                        for account_info in response['Accounts']:
                            if 'Id' in account_info:
                                account_ids_lst.append(account_info['Id'])

                except Exception as e:
                    logging.critical("CloudServiceFunctions (ERROR) - while trying to get account ids by organization: " + str(e))

                return account_ids_lst

            def update_cyngular_bucket():
                try:
                    s3_client = boto3.client('s3')
                    
                    response = s3_client.get_bucket_policy(
                        Bucket='cyngular-${ClientName}-bucket-${AWS::AccountId}'
                    )
                    
                    account_ids_list = get_account_ids_lst_by_organization()
                    account_arns_list = []
                    organization_accounts_ids_list = []
                    for account_id in account_ids_list:
                        account_arns_list.append(f"\"arn:aws:logs:*:{account_id}:*\"")
                        organization_accounts_ids_list.append(f"\"{account_id}\"")
                    new_statement = '''[
                        {
                            "Sid": "AWSLogDeliveryWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "delivery.logs.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": "${CyngularS3Bucket.Arn}/*",
                            "Condition": {
                                "ArnLike": {
                                    "AWS:SourceArn": [$%ACCOUNT_ARNS_LIST%$]
                                }
                            }
                        },
                        {
                            "Sid": "AWSLogDeliveryAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "delivery.logs.amazonaws.com"
                            },
                            "Action": [
                                "s3:GetBucketAcl",
                                "s3:ListBucket"
                            ],
                            "Resource": "${CyngularS3Bucket.Arn}",
                            "Condition": {
                                "ArnLike": {
                                    "aws:SourceArn": [$%ACCOUNT_ARNS_LIST%$]
                                }
                            }
                        }
                    ]
                '''.replace('$%ACCOUNT_ARNS_LIST%$', ','.join(account_arns_list)).replace('$%ACCOUNT_IDS_LIST%$', ','.join(organization_accounts_ids_list))
                    new_statement_json = json.loads(new_statement)
                    reponse_policy = json.loads(response['Policy'])
                    statement_policy = reponse_policy['Statement']
                    statement_policy.extend(new_statement_json)
                    new_policy = {}
                    new_policy['Statement'] = statement_policy
                    new_policy['Version'] = '2012-10-17'

                    response = s3_client.put_bucket_policy(
                        Bucket='cyngular-${ClientName}-bucket-${AWS::AccountId}',
                        Policy=json.dumps(new_policy)
                    )
                    logging.info(response)
                except Exception as e:
                    logging.critical(str(e))
                
            def cyngular_function(event, context):
                  
                try:
                    logging.info('STRATING CYNGULARS FUNCTION...')
                    ec2_client = boto3.client('ec2')
                    events_client=boto3.client('events')
                    logging.info('UPDATING CYNGULAR BUCKET POLICY')
                    update_cyngular_bucket()
                    logging.info('DONE!')

                except Exception as e:
                    logging.critical(str(e))
      Runtime: "python3.9"
      Handler: index.cyngular_function
      Timeout: 300
      Role: !GetAtt LambdasRole.Arn

  ManagerLambdaRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: !Join ['-', ['cyngular-manager-lambda-role', !Ref ClientName]]
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: "CloudFormationPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "lambda:InvokeFunction"
                  - "lambda:InvokeAsync"
                  - "lambda:GetFunction"

                  - "logs:*"

                  - "cloudformation:DescribeStacks"
                  - "cloudformation:DescribeStackSet"
                  - "cloudformation:CreateStack"
                  - "cloudformation:CreateStackSet"
                  - "cloudformation:CreateStackInstances"
                  - "cloudformation:GetTemplateSummary"
                  - "cloudformation:DescribeStackSetOperation"
                  - "cloudformation:ListStackSetOperationResults"
                  - "cloudformation:DeleteStackSet"
                  - "cloudformation:DeleteStackInstances"

                  - "guardduty:TagResource"
                  - "guardduty:ListDetectors"
                  - "guardduty:CreateDetector"

                  - "organizations:ListAccounts"

                  - "sts:GetCallerIdentity"

                  - "s3:GetObject"

                  - "iam:GetRole"
                  - "iam:DetachRolePolicy"
                  - "iam:AttachRolePolicy"
                  - "iam:DeleteRolePolicy"
                  - "iam:PutRolePolicy"
                  - "iam:getRolePolicy"
                Resource:
                  - "*"

  CreateAdminAndExecutionRolesLambdaRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: !Join ['-', ['cyngular-admin-and-exec-roles-lambda-role', !Ref ClientName]]
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: "CloudFormationPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "cloudformation:DescribeStacks"
                  - "cloudformation:CreateStack"
                  - "cloudformation:CreateStackSet"
                  - "cloudformation:DescribeStackSet"
                  - "cloudformation:CreateStackInstances"
                  - "cloudformation:DescribeStackSetOperation"
                  - "cloudformation:DeleteStackInstances"
                  - "cloudformation:ListStackSetOperationResults"
                  - "cloudformation:UpdateStackSet"
                  - "cloudformation:UpdateStackInstances"
                  - "cloudformation:DeleteStackSet"
                  - "cloudformation:ListStackInstances"
                  - "cloudformation:DescribeStackEvents"
                  - "cloudformation:ExecuteChangeSet"
                  - "cloudformation:CreateChangSet"

                  - "organizations:ListAccounts"
                  - "organizations:ListRoots"

                  - "s3:GetObject"
                  
                  - "iam:GetRole"
                  - "iam:CreateRole"
                  - "iam:AttachRolePolicy"
                  - "iam:PutRolePolicy"
                  - "iam:getRolePolicy"
                  
                  - "logs:*"
                Resource:
                  - "*"

  CyngularManagerLambda:
    DependsOn: [ManagerLambdaRole, CyngularLambdaE,CyngularS3Bucket, CreateAdminAndExecutionRolesLambda]
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: cyngular-lambda-manager-function
      Description: Created by Cyngular Security.
      Code:
        ZipFile: !Sub |
            import boto3
            import time
            import os
            import cfnresponse
            import logging

            def get_child_accounts(management_account_id):
                """
                Gets a list of all child accounts in the organization from a management account.
                """
                org_client = boto3.client('organizations')
                
                # Get a list of all accounts in the organization
                account_list = org_client.list_accounts()
                
                # Create a list to store the child accounts
                child_accounts = []
                
                # Loop through each account in the list and check if it is a child account
                for account in account_list['Accounts']:
                    if account['Id'] != management_account_id:
                        child_accounts.append(account['Id'])
                
                # Return the list of child accounts
                return child_accounts

            def guardduty_exists(region):
                client = boto3.client('guardduty', region)
                response = client.list_detectors()
                if len(response['DetectorIds']) == 0:
                    return False
                return True
            def create_guardduty():
                ClientRegionsList = os.environ['ClientRegions'].split(',')
                for region in ClientRegionsList:
                    if guardduty_exists(region):
                        logging.info(f'guardduty found in {region}, adding cyngular tag')
                        client = boto3.client('guardduty', region)
                        response = client.list_detectors()
                        detector_id = response['DetectorIds'][0]
                        # add cyngular tag
                        sts_client = boto3.client('sts')
                        account_id = sts_client.get_caller_identity()['Account']
                        response = client.tag_resource(Tags={'Value' : 'cyngular-guardduty'}, ResourceArn=f'arn:aws:guardduty:{region}:{account_id}:detector/{detector_id}')
                    
                    else:
                        logging.info(f'creating guardduty in {region}')
                        # create guard duties
                        client = boto3.client('guardduty', region)
                        detector_properties = {
                            'Enable': True,
                            'FindingPublishingFrequency': 'FIFTEEN_MINUTES',
                            'DataSources': {
                                'S3Logs': {
                                    'Enable': True
                                },
                            },
                            'Tags': [
                                {
                                    'Value': 'cyngular-guardduty'
                                }
                            ]
                        }
                        
                        # Create the detector
                        response = client.create_detector(
                            Enable=True,
                            FindingPublishingFrequency='FIFTEEN_MINUTES',
                            DataSources=detector_properties['DataSources'],
                            Tags=detector_properties['Tags'][0]
                        )
            def create_stack2(url):
                stack_client = boto3.client('cloudformation')
                stack_client.create_stack(
                    StackName='cyngular-stack2',
                    TemplateURL=url,
                    Parameters=[
                        {
                            'ParameterKey': 'ClientName',
                            'ParameterValue': os.environ['ClientName']
                        },
                        {
                            'ParameterKey': 'deployRegions',
                            'ParameterValue': os.environ['ClientRegions']
                        },
                        {
                            'ParameterKey': 'S3ManagementBucketArn',
                            'ParameterValue': os.environ['S3BucketArn']
                        },
                        {
                            'ParameterKey': 'CyngularAccountId',
                            'ParameterValue': os.environ['CyngularAccountId']
                        }
                    ],
                    Capabilities=['CAPABILITY_IAM']
                )
            def create_stackset1(child_accounts,url):
                stack_client = boto3.client('cloudformation')
                client = boto3.client('s3') # example client, could be any
                stack_client.create_stack_set(
                StackSetName='cyngular-stackset-1',
                PermissionModel='SELF_MANAGED',
                TemplateURL=url,
                Parameters = [

                    {
                        'ParameterKey': 'ClientName',
                        'ParameterValue': os.environ['ClientName']
                    },
                    {
                        'ParameterKey': 'CyngularAccountId',
                        'ParameterValue': os.environ['CyngularAccountId']
                    },
                    {
                        'ParameterKey': 'S3BucketArn',
                        'ParameterValue': os.environ['S3BucketArn']
                    },
                    {
                        'ParameterKey': 'ClientRegions',
                        'ParameterValue': (os.environ['ClientRegions']).replace(',',' ')
                    }
                ],
                    Capabilities=['CAPABILITY_IAM',"CAPABILITY_NAMED_IAM"]
                
                )
                stack_client.create_stack_instances(
                        StackSetName = 'cyngular-stackset-1',
                        DeploymentTargets = {
                            "Accounts": child_accounts
                        },
                        OperationPreferences = {
                            'RegionConcurrencyType': 'PARALLEL',
                            'FailureTolerancePercentage': 100,
                            'MaxConcurrentPercentage': 100
                        },
                        Regions = [client.meta.region_name],
                    
                )
            def create_stackset2(child_accounts,url):
                stack_client = boto3.client('cloudformation')
                stack_client.create_stack_set(
                StackSetName='cyngular-stackset-2',
                PermissionModel='SELF_MANAGED',
                TemplateURL=url,
                Parameters=[
                    # {
                    #     'ParameterKey': 'ClientName',
                    #     'ParameterValue': os.environ['ClientName']
                    # },
                    {
                        'ParameterKey': 'CyngularAccountId',
                        'ParameterValue': os.environ['CyngularAccountId']
                    },
                    {
                        'ParameterKey': 'S3BucketArn',
                        'ParameterValue': os.environ['S3BucketArn']
                    },
                    {
                        'ParameterKey': 'ClientRegions',
                        'ParameterValue': os.environ['ClientRegions']
                    }
                ],
                    Capabilities=['CAPABILITY_IAM',"CAPABILITY_NAMED_IAM"]
                )
                stack_client.create_stack_instances(
                        StackSetName = 'cyngular-stackset-2',
                        DeploymentTargets = {
                            "Accounts": child_accounts
                        }
                        ,OperationPreferences = {
                            'RegionConcurrencyType': 'PARALLEL',
                            'FailureTolerancePercentage': 100,
                            'MaxConcurrentPercentage': 100
                        },
                        Regions = os.environ["ClientRegions"].split(','),
                    )

            def invoke_lambdaE():
                try:
                    lambda_client = boto3.client('lambda')
                    response = lambda_client.invoke(
                        FunctionName='cyngular-lambda-update-cyngular-bucket',
                        InvocationType = 'RequestResponse',
                        LogType='Tail',
                    )
                    logging.info('lmbada E invoked!')
                    if response['StatusCode'] != 200:
                        logging.critical(f"Error {response}")
                except Exception as e:
                    logging.critical(str(e))

            def cyngular_function(event, context):
                try:
                    logging.basicConfig(format='%(asctime)s - %(levelname)s - %(message)s', level=logging.INFO)
                    logger = logging.getLogger()
                    logger.setLevel(logging.INFO)
                    logging.info('STARTING CYNGULAR\'S FUNCTION...')

                    #printing event for responseurl
                    logging.info(f"copy this to manually delete the custom resource: \n{event}")

                    # if the stack is being created
                    if event['RequestType'] == 'Create':        
                        try:
                            stack2_url = event['ResourceProperties']['Stack2URL']
                            stackset1_url = event['ResourceProperties']['StackSet1URL']
                            stackset2_url = event['ResourceProperties']['StackSet2URL']
                            child_accounts = get_child_accounts(os.environ['currentAccountId'])
                            invoke_lambdaE()
                            logging.info("CREATING CYNGULAR STACK2")
                            create_stack2(stack2_url)
                            logging.info("STARING CYNGULAR STACKSET1")
                            create_stackset1(child_accounts,stackset1_url)
                            logging.info("Creating GuardDuties")
                            create_guardduty()
                            logging.info("STARING CYNGULAR STACKSET2")
                            create_stackset2(child_accounts,stackset2_url)
                            logging.info("DONE WITH ALL CYNGULAR STACKS!")
                            cfnresponse.send(event, context, cfnresponse.SUCCESS, {'msg' : 'Done'})

                        except Exception as e:
                            logging.critical(str(e))
                            cfnresponse.send(event, context, cfnresponse.FAILED, {'msg' : str(e)})
                    else:
                        cfnresponse.send(event, context, cfnresponse.SUCCESS, {'msg' : 'No error'})
                except Exception as e:
                    logging.critical(str(e))
                    cfnresponse.send(event, context, cfnresponse.FAILED, {'msg' : str(e)})
      Runtime: "python3.9"
      Handler: index.cyngular_function
      Timeout: 300
      Environment:
        Variables:
          ClientName: !Ref ClientName
          ClientRegions: !Join [",", !Ref ClientRegions]
          CyngularAccountId: !Ref CyngularAccountId
          S3BucketArn: !GetAtt CyngularS3Bucket.Arn
          currentAccountId: !Ref AWS::AccountId
        #   CreatedBucketArn: !GetAtt CyngularS3Bucket.Arn
            
      Role: !GetAtt ManagerLambdaRole.Arn

  ManagerLambdaTrigger:
    Type: AWS::CloudFormation::CustomResource
    Version: "1.0"
    Properties:
      ServiceToken: !GetAtt CyngularManagerLambda.Arn
      Stack2URL: !Ref Stack2URL
      StackSet1URL: !Ref StackSet1URL
      StackSet2URL: !Ref StackSet2URL

  CreateAdminAndExecutionRolesLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: cyngular-lambda-admin-and-execution-roles
      Description: Created by Cyngular Security.
      Code:
        ZipFile: !Sub |
            import boto3
            import time
            import os
            import cfnresponse
            import logging

            #ROLE TEMPLATES:

            ADMIN_ROLE_TEMPLATE = """
            AWSTemplateFormatVersion: 2010-09-09
            Description: Configure the AWSCloudFormationStackSetAdministrationRole to enable use of AWS CloudFormation StackSets.

            Resources:
              AdministrationRole:
                Type: AWS::IAM::Role
                Properties:
                  RoleName: AWSCloudFormationStackSetAdministrationRole
                  AssumeRolePolicyDocument:
                    Version: 2012-10-17
                    Statement:
                      - Effect: Allow
                        Principal:
                          Service: cloudformation.amazonaws.com
                        Action:
                          - sts:AssumeRole
                  Path: /
                  Policies:
                    - PolicyName: AssumeRole-AWSCloudFormationStackSetExecutionRole
                      PolicyDocument:
                        Version: 2012-10-17
                        Statement:
                          - Effect: Allow
                            Action:
                              - sts:AssumeRole
                            Resource:
                              - "arn:*:iam::*:role/AWSCloudFormationStackSetExecutionRole"
            """

            EXECUTION_ROLE_TEMPLATE = """
            AWSTemplateFormatVersion: 2010-09-09
            Description: Configure the AWSCloudFormationStackSetExecutionRole to enable use of your account as a target account in AWS CloudFormation StackSets.

            Parameters:
              AdministratorAccountId:
                Type: String
                Description: AWS Account Id of the administrator account (the account in which StackSets will be created).
                MaxLength: 12
                MinLength: 12

            Resources:
              ExecutionRole:
                Type: AWS::IAM::Role
                Properties:
                  RoleName: AWSCloudFormationStackSetExecutionRole
                  AssumeRolePolicyDocument:
                    Version: 2012-10-17
                    Statement:
                      - Effect: Allow
                        Principal:
                          AWS:
                            - !Ref AdministratorAccountId
                        Action:
                          - sts:AssumeRole
                  Path: /
                  ManagedPolicyArns:
                    - !Sub arn:${AWS::Partition}:iam::aws:policy/AdministratorAccess
            """

            def check_role_existence(role_name):
                iam_client = boto3.client('iam')
                try:
                    iam_client.get_role(RoleName=role_name)
                    print(f"The IAM role '{role_name}' exists.")
                    return True
                except Exception as e:
                    print(str(e))
                    return False
            def wait_for(stack_name):
                client = boto3.client('cloudformation')
                waiter = client.get_waiter('stack_create_complete')
                waiter.wait(StackName=stack_name)

            def wait_for_stackset_creation(stackset_name, operation_id):
                client = boto3.client('cloudformation')
                # Get the current status of the StackSet
                response = client.describe_stack_set_operation(
                    StackSetName=stackset_name,
                    OperationId=operation_id
                )
                status = response['StackSetOperation']['Status']
                # Wait for the StackSet to finish creating
                while status == 'RUNNING':
                    time.sleep(10)
                    response = client.describe_stack_set_operation(
                        StackSetName=stackset_name,
                        OperationId=operation_id
                    )
                    status = response['StackSetOperation']['Status']
                if status == 'SUCCEEDED':
                    logging.info('StackSet creation completed successfully.')
                else:
                    logging.info('StackSet creation failed.')

            def get_child_accounts(management_account_id):
                """
                Gets a list of all child accounts in the organization from a management account.
                """
                org_client = boto3.client('organizations')
                
                # Get a list of all accounts in the organization
                account_list = org_client.list_accounts()
                
                # Create a list to store the child accounts
                child_accounts = []
                
                # Loop through each account in the list and check if it is a child account
                for account in account_list['Accounts']:
                    if account['Id'] != management_account_id:
                        child_accounts.append(account['Id'])
                
                # Return the list of child accounts
                return child_accounts

            def create_executionrole_on_childs(child_accounts):
                org_client = boto3.client('organizations')
                root_response = org_client.list_roots()
                if 'Roots' in root_response and len(root_response['Roots']) > 0:
                    root_id = root_response['Roots'][0]['Id']
                else:
                    print("Could not fetch the root ID.")
                    exit(1)

                stack_client = boto3.client('cloudformation')
                stack_client.create_stack_set(
                StackSetName='cyngular-execution-role-stackset',
                PermissionModel='SERVICE_MANAGED',
                AutoDeployment={
                    'Enabled': True,
                    'RetainStacksOnAccountRemoval': True
                },
                TemplateBody=EXECUTION_ROLE_TEMPLATE,
                Parameters=[
                    { 
                        'ParameterKey': 'AdministratorAccountId',
                        'ParameterValue': os.environ['currentAccountId']
                    },
                ],
                    Capabilities=['CAPABILITY_IAM',"CAPABILITY_NAMED_IAM"]
                )
                result = stack_client.create_stack_instances(
                        StackSetName = 'cyngular-execution-role-stackset',
                        OperationPreferences = {
                            'RegionConcurrencyType': 'PARALLEL',
                            'FailureTolerancePercentage': 100,
                            'MaxConcurrentPercentage': 100
                        },
                        DeploymentTargets = {
                            "OrganizationalUnitIds": [root_id] # [os.environ["RootOUid"]]
                        },
                        Regions = [os.environ["ClientRegions"].split(',')[0]]

                    )
                wait_for_stackset_creation("cyngular-execution-role-stackset", result["OperationId"])

            #sets up both the execution and admin role in the management account
            def create_management_execution_role():
                stack_client = boto3.client('cloudformation')
                # Create the new stack with the extracted value of ClientName
                if not check_role_existence("AWSCloudFormationStackSetExecutionRole"):
                    stack_client.create_stack(
                        StackName='cyngular-managment-execution-role',
                        TemplateBody=EXECUTION_ROLE_TEMPLATE,
                        Parameters=[
                            {
                                'ParameterKey': 'AdministratorAccountId',
                                'ParameterValue': os.environ['currentAccountId']
                            },
                            ],
                            Capabilities=['CAPABILITY_IAM', 'CAPABILITY_NAMED_IAM']
                            )
                    wait_for("cyngular-managment-execution-role")

            def create_management_admin_role():
                stack_client = boto3.client('cloudformation')
                # Create the new stack with the extracted value of ClientName
                if not check_role_existence("AWSCloudFormationStackSetAdministrationRole"):
                    stack_client.create_stack(
                        StackName='cyngular-managment-admin-role',
                        TemplateBody=ADMIN_ROLE_TEMPLATE,
                        Capabilities=['CAPABILITY_IAM', 'CAPABILITY_NAMED_IAM']
                        )
                    wait_for("cyngular-managment-admin-role")

            def cyngular_function(event, context):
                try:
                    logging.basicConfig(format='%(asctime)s - %(levelname)s - %(message)s', level=logging.INFO)
                    logger = logging.getLogger()
                    logger.setLevel(logging.INFO)
                    # if the stack is being created
                    if event['RequestType'] == 'Create':        
                        try:
                            child_accounts = get_child_accounts(os.environ['currentAccountId'])
                            logging.info("CREATING ROLES ON MANAGEMENT ACCOUNT")
                            create_management_execution_role()
                            create_management_admin_role()
                            logging.info("CREATING ROLES ON CHILDS")
                            create_executionrole_on_childs(child_accounts)
                            logging.info("DONE WITH ALL CYNGULAR STACKS!")
                            cfnresponse.send(event, context, cfnresponse.SUCCESS, {'msg' : 'Done'})

                        except Exception as e:
                            logging.critical(str(e))
                            cfnresponse.send(event, context, cfnresponse.FAILED, {'msg' : str(e)})
                    else:
                        cfnresponse.send(event, context, cfnresponse.SUCCESS, {'msg' : 'No error'})
                except Exception as e:
                    logging.critical(str(e))
                    cfnresponse.send(event, context, cfnresponse.FAILED, {'msg' : str(e)})
      Runtime: "python3.9"
      Handler: index.cyngular_function
      Timeout: 300
      Environment:
        Variables:
          ClientName: !Ref ClientName
          ClientRegions: !Join [",", !Ref ClientRegions]
          CyngularAccountId: !Ref CyngularAccountId
          S3BucketArn: !GetAtt CyngularS3Bucket.Arn
        #   RootOUid: !Ref RootOUid
          currentAccountId: !Ref AWS::AccountId
          
      Role: !GetAtt CreateAdminAndExecutionRolesLambdaRole.Arn

#   CreateAdminAndExecutionRoles:
#     Type: AWS::CloudFormation::CustomResource
#     Version: "1.0"
#     Properties:
#       ServiceToken: !GetAtt CreateAdminAndExecutionRolesLambda.Arn

  DeleteCustomResourceLambdaRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: "CloudFormationPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "logs:*"
                Resource: '*'

  DeleteCustomResourceLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: cyngular-lambda-delete-custom-resource
      Description: Created by Cyngular Security.
      Code:
        ZipFile: !Sub |
          import cfnresponse
          '''
          This function was created by cyngular security to delete a custom resource that is stuck
          on creation or deletion. Before running this function, make sure that the resource is actually stuck
          and not just taking time to complete (check the logs).
          If it truly is stuck, copy the event json from the logs and paste them below.
          Then run the function and confirm that the resource was successfully deleted.
          '''
          def lambda_handler(event, context):
            event = {} # copy and paste event from manager lambda logs to here
            cfnresponse.send(event, context, cfnresponse.FAILED, {'msg' : 'Custom resource manually deleted'})
      Runtime: "python3.9"
      Handler: index.cyngular_function
      Timeout: 300
      Role: !GetAtt DeleteCustomResourceLambdaRole.Arn